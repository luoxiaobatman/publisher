---
created: 2023-09-20
number headings: first-level 2, start-at 1, max 6, 1.1-
title: 版本与升级.架构设计.p1
author: 罗潇
cssclass: wideTable
first-level: 1
pdf-filename: 版本与升级.架构设计.p1
platform: true
category: hide
---

### 版本规划

版本格式：主版本号.次版本号.修订号，版本号递增规则如下：

主版本号：当做了无法向下兼容的修改时修改主版本号；

次版本号：当做了向下兼容的功能性变更时修改次版本号；

修订号：当做了向下兼容的BUG修正时修改修订号；

基础平台第一个版本，版本号规划为1.0.0。

### 软件升级机制

各个服务软件升级时，升级流程会先停服务、备份历史软件到备份目录、拷贝新软件覆盖软件安装目录、再启动容器实现服务升级。

升级后，如果验证服务异常，则可以手工恢复历史软件来实现升级回退。

考虑到磁盘空间的使用，备份目录只保留最近一次历史软件的备份。

### DB升级机制

DB升级机制没有备份恢复，DB升级通过设置约束向下兼容来规避升级回滚的需求。DB变更遵循以下约束：

* 新增表

新增表时，在升级脚本中通过SQL完成表创建、数据初始化和表约束配置。

* 删除表

DB升级，不允许删除表。

* 新增字段

新增字段时，在升级脚本中通过SQL完成字段新增、类型设置、必填项时的默认值设置

* 修改字段

DB升级，不允许修改字段，比如字段类型、字段约束，对于字段类型修改只能新增一个字段并把老字段的值拷贝到新字段来使用；字段约束通过业务控制或默认值实现。

* 删除字段

DB升级，不允许删除字段。

* 修改初始化数据

新增、修改、删除初始化数据时，同样在升级脚本中通过SQL完成。

说明：任何版本的DB升级，必须基于上版本DB的基础上对DB进行修改，比如1.0.0有一条初始化数据，1.0.1版本删除了该数据，1.0.2该数据时需要基于1.0.1执行insert语句，而非基于1.0.0执行update。

### 跨版本升级

以上的升级机制能够满足次版本号和修订号的跨版本升级。

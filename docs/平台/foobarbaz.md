---
created: 2023-09-18
number headings: first-level 2, start-at 1, max 6, 1.1-
title: foobarbaz
author: 罗潇
cssclass: wideTable
first-level: 1
pdf-filename: foobarbaz
platform: true
category: 平台
---

## 简介

### 目的

该文档为基础平台系统架构设计文档，从功能架构、逻辑架构、子系统、业务流程等层面对平台架构进行说明，描述产品功能、产品构成、子系统功能、子系统间的数据交互等，为产品概要设计、开发、测试提供支撑。

### 范围

该文档只包含基础平台的系统架构设计，基础平台的API设计、事件设计和特性设计由单独的文档描述，不包含在该文档中。

该文档适用于SE、产品经理、研发经理、开发人员和测试人员。

SE：该文档由SE进行维护，并参考该文档进行其他API、特性等设计，需要修改该文档时需要由SE发起修改评审，评审通过后进行文档修改。

产品经理：确认架构设计是否符合产品需求说明、是否涵盖了产品需求范围。

研发经理：通过该文档指导研发技术方向、验收研发成果。

开发人员：参考该文档进行详细设计并作为后期开发的依据。

测试人员：参考该文档进行测试方案和测试用例编写。

## 产品介绍

产品介绍包括产品功能说明和产品构成。

### 产品功能说明

基础平台实现统一用户管理、统一资源和帐号管理、实现统一认证、和系统管理功能。基础平台实现用户、资源等统一配置，并把配置下发给能力组件，借助各种能力组件实现相应的管控效果。

基础平台提供的是产品无关的、通用功能开发，核心关注用户、资源、认证和系统管理，对外输出基础平台，其他产品只需开发个性化业务，对于用户、资源、认证和系统管理可以直接复用基础平台。

### 产品构成

基础平台实现用户、认证、资源和帐号等配置数据的集中管理，通过数据同步组件把相应的配置数据同步给堡垒机、ASCG、DataServer和UIAM等能力组件，借助能力组件实现运维通道、业务通道和文件通道等管控，如下图：

![[../media/产品构成.excalidraw.svg|产品构成.excalidraw]]

以下介绍的基础平台架构设计只包含平台本身，不包括堡垒机、ASCG、DataServer、UIAM等能力组件。


## 系统架构设计

系统架构设计从产品的功能架构、逻辑架构、功能架构、子系统划分、子系统核心功能说明、子系统之间的数据交互、业务流程、静态架构、产品集成、产品部署等方面进行描述。

### 功能架构

[[./function.design.platform|function.design.platform]]

### 逻辑架构

整体逻辑架构分为视图、业务逻辑和数据层。

视图层提供前端展示，支持浏览器、api、PC端、移动端等多种访问手段，保证安全性都通过https进行访问。

业务逻辑层实现认证、用户、资源、系统的业务逻辑处理和业务控制，除四大业务中心外，还包括API网关、消息中心、缓存中心、后台服务及进程守护程序。

数据层实现数据存取，认证中心、用户管理、资源管理和系统管理数据库相互独立，可以单独部署，也可以在同一个库上运行四个数据库实例。

### 子系统介绍

基础平台包括：认证中心、用户管理、资源管理、系统管理、API网关、消息中心、缓存中心、系统配置、系统日志、短信服务、邮件服务、数据同步、定时任务、帐号采集、帐号改密、升级服务、主备服务和进程守护服务。


认证中心提供统一登录界面，实现多种认证因子的身份认证、票据管理、认证转发，实现基于CAS、OAuth、SAML等多种标准协议的应用接入认证和单点登录功能。

认证中心同时提供票据服务，为API网关的请求提供票据生成和校验功能。

* 用户管理

用户管理包括用户属性管理、用户组织/用户组管理、用户口令策略管理、用户登录策略管理和OTP认证因子管理。

* 资源管理

实现资源管理、资源组管理、帐号管理、口令策略以及基于资源的敏感数据发现、帐号核查、一致性稽核、帐号改密等功能。

* 系统管理

系统管理主要实现系统角色管理、系统配置管理、系统信息管理、堡垒机管理、接口管理和热备管理。

* API网关

API网关为所有内外部请求的入口。基于安全考虑，所有外部请求通过https协议请求API网关，由API网关转发请求给具体子系统，为提高效率，内部子系统之间的请求通过http协议请求API网关，由API网关转发请求给相应的子系统。

请求到API网关后，API网关和认证中心联动完成当前请求的鉴权，鉴权通过后进行后续的业务操作。为避免API网关出现瓶颈，不承载业务处理，具体业务由各子系统和后台服务完成。

API网关采用traefik实现，traefik设计上考虑了更多的安全性，支持docker状态监控。

* 消息中心

消息中心实现子系统和后台服务之间的数据交互。

子系统向后台服务同步消息时，在不增加业务复杂度的前提下尽可能把后台服务所需的信息都同步过去，减少后台服务再次查询数据。

后台服务需要查询数据时，优先通过API网关查询子系统的API查询数据，如果需要查询的数据过于复杂，可以考虑由后台服务直接访问数据库。

消息中间件采用kafka。

* 缓存中心

缓存中心把频繁使用的配置信息缓存起来，提高访问性能、减少DB操作，比如堡垒机地址每次调用接口执行运维操作时都用到，可以写入缓存中心。

缓存中心采用Redis。

* 系统配置服务

系统配置服务为后台服务，以root运行，承载对操作系统的配置，包括网络配置、电源配置、时间配置、服务启停和各服务地址维护。系统管理子系统提供业务操作，驱动系统配置服务完成具体的配置动作。

* 系统日志服务

系统日志服务为后台服务，提供所有子系统和服务的日志记录功能。所有子系统和服务把日志通过消息中心给系统日志服务，由系统日志服务完成日志持久化及日志外发动作。

* 短信服务

承载系统所有短信的发送功能，短信服务从消息中心订阅需要发送短信的事件，完成短信网关连接管理和具体的发送。

* 邮件服务

承载系统所有邮件的发送功能，邮件服务从消息中心订阅需要发送邮件的事件，完成邮件服务器连接管理和具体的发送。

* 数据同步

数据同步实现平台和堡垒机、ASCG、DataServer等能力组件之间的数据同步，由平台适配能力组件的接口把数据推送给各能力组件。

* 定时任务

提供系统运行日志清理、配置备份、堡垒机状态周期查询等定时和周期执行的任务。

* 帐号采集服务

帐号采集服务为后台服务，实现从目标资源采集帐号到平台。

* 帐号改密服务

帐号改密服务为后台服务，实现修改目标资源上帐号的密码的功能。

* 升级服务

升级服务为后台服务，以root运行，实现升级包下载、服务升级和升级结果上报功能。

* 主备服务

主备服务为后台服务，完成主备机器之间的状态监控、主备机之间的数据同步和事件处理功能。

* 进程守护服务

进程守护服务提供对所有前端服务、后端服务、中间件和后台服务的进程进行监控和启停，当监控到服务异常时进行服务重启，最多尝试重启三次，最大程度保证业务连续性。

进程守护服务采用supervisor。

* 通知服务

<mark style="background: #CE1515;">通知服务用于订阅前台服务发送的提醒、告警、验证码等事件，完成事件和提醒、告警、验证码模板的整合，形成以明确的通知方式的通知内容，以事件的方式把内容发送到消息中心，由短信服务、邮件服务等服务订阅并完成提醒、告警和验证码的发送。</mark> 

### 1.1. 子系统数据交互

子系统之间的数据交互，从业务数据、通知数据和缓存数据三方面进行展开。

### 3.4.1. 业务数据

子系统之间的业务数据交互如下图：

基础平台各服务之间通过API网关实现数据交互。

系统管理写入系统权限和系统配置，其中系统权限管理需要读用户信息、堡垒机管理需要读取资源信息。

用户管理通过API网关输出用户信息，用户的权限视图需要输入系统权限。

资源管理通过API网关输出资源、帐号等信息，资源的协议功能需要输入系统配置。

认证中心根据用户信息、资源信息和系统配置完成身份认证，输出认证结果。

定时任务需要根据输入的系统配置和资源信息从ASCG采集帐号和授权信息、采集系统组件状态信息。

数据同步需要输入系统配置信息，并把用户、资源等信息同步给各能力组件。

接口服务需要输入系统配置信息，并和外部系统交互实现用户、资源等信息的双向同步。

详细API参考API设计文档。

### 3.4.2. 事件数据

消息中心实现服务之间的事件交互，分为业务事件和系统运行日志两部分。

* 业务事件


用户管理、资源管理、系统管理、认证中心及数据同步、系统配置、系统升级等后台服务会产生数据变更、配置、升级、认证等事件，并把事件发送到消息中心，不同的后台服务通过订阅相应的事件完成业务操作。

1） 事件生产者发送事件时需要带上产生事件的操作人和事件产生时间，避免因为事件传输消耗时间而影响事件的使用，比如系统日志服务记录日志时需要记录事件的产生时间，用于日志排查。

2） 数据同步服务订阅用户变更、资源、帐号变更等消息，把变更的数据同步给堡垒机、ASCG等能力组件。变更的实体视具体情况尽可能包含完整实体信息，减少数据同步服务查询API及DB的概率。

3） 通知服务订阅提醒、告警、验证码等事件，完成事件和提醒、告警、验证码模板的整合，形成完成的通知内容，以短信事件、邮件事件的方式把内容发送到消息中心。

4） 短信服务订阅发短信的事件，完成短信发送。短信消息必须包括短信内容、短信发送人信息。

5） 邮件服务订阅发邮件事件，完成邮件发送。邮件消息必须包括邮件内容、邮件接收人信息。

6） 系统配置服务订阅网络、时间、电源等配置事件，完成系统配置。

7） 升级服务订阅系统升级事件，完成升级包下载、服务备份、服务升级和升级事件上报等功能。

8） 系统日志服务订阅几乎所有的变更事件，完成系统登录日志记录、业务操作日志记录、日志外发等功能。

其中产生事件的各服务不关注日记级别和日志格式，由日志服务根据模块和操作动作来定义日志级别、由日志服务根据DB设计需求定义日志格式。

* 系统运行日志

平台各服务运行产生的日志通过log4j把产生的日志以事件的形式发送到消息中心，由系统日志服务订阅事件，并把系统运行日志以服务进行区分、以文件形式记录到本地，便于前端通过界面下载系统各服务的运行日志。

Web业务模块注解产生的日志会详细记录前端请求的参数，这些日志也会统一以文件形式记录到系统运行日志中，便于进行问题排查。

消息中心事件发送者定义、详细事件参考事件设计文档。

### 3.4.3. 缓存数据

* 设计原则

缓存中心把频繁读取及多个服务共用的数据缓存起来，提高数据读取的效率、减少对DB的查询，同时多个服务可以共用缓存中心的数据，避免每个服务各自缓存数据，缓存中心遵循的原则是“使用频繁或多服务公用的数据、变更不频繁的数据”。

* 读缓存机制


以系统管理服务为例，服务查询数据时首先从缓存中读数据，第一次发现缓存中不存在相应数据，则从DB查询，并把查询到的数据写入缓存中心。第二次查询该数据时，缓存中心已存在该数据，可从缓存中心直接读取到数据，减少了DB访问。

* 清缓存机制


为避免DB和缓存中心数据不一致的问题，当DB数据需要变更或删除时，先删除缓存中的数据，再执行DB操作。当该数据被再次使用时遵循读缓存机制，先从DB查询最新的数据，并把查询到的数据写入缓存，供后续使用。

* 缓存数据规划

基于以上原则，基础平台需要缓存的数据种类如下：

| 需要缓存的数据          | Key规划                                      | 使用场景                                                         | 有效期** | 
| ----------------------- | -------------------------------------------- | ---------------------------------------------------------------- | -------- |
| 能力组件地址            | PLATFORM_T_SYS_CAPBILITY_COMPONENT           | 数据同步、状态查询、接口调用时使用                               | 30天     |
| 短信服务器地址          | PLATFORM_T_SYS_SMS                           | 发短信时使用                                                     | 30天     |
| 邮件服务器地址          | PLATFORM_T_SYS_MAIL                          | 发邮件时使用                                                     | 30天     |
| AD域/LDAP地址           | PLATFORM_T_USER_AD                           | 认证转发、数据同步或采集时使用                                   | 30天     |
| Radius服务器地址        | PLATFORM_T_AUTHEN_RADIUS                     | 认证转发时使用                                                   | 30天     |
| 日志外发地址            | PLATFORM_T_SYS_LOG_SEND                      | 日志外发时使用                                                   | 30天     |
| 系统参数                | PLATFORM_T_SYS_PARAM_XXX                     | 系统登录配置（登录错误几次有验证码、锁屏时间等）、系统应急配置等 | 30天     |
| 资源和能力组件关系      | PLATFORM_T_SYS_CAPBILITY_COMPONENT_RES#resId | 数据同步和运维登录时，根据资源选择指定的能力组件                 | 30天     |
| 审计分析规则            | PLATFORM_T_AUDIT_POLICY                      | 审计日志分析时使用                                               | 30天     |
| 文档管控Samba用户和密码 | PLATFORM_T_SYS_DATASERVER_USER#userName      | 登录18版堡垒机时需要把DataServer的Samba的帐号和密码带过去        | 5分钟    |
| 工具、协议及关联关系    | PLATFORM_T_RES_PROTOCOL_TOOL#protocol        | portal登录时使用                                                 | 30天     |
| 产品扩展                | DSMP_ T_RISK_xxx                             | DSMP产品风险中心                                                 | Xxx      |

说明：

1） Kye的规划和数据库表名前面相同，比如比如短信服务器配置表名t_sys_xxx，Key为T_SYS_xxx；在基础平台上产品的Key统一以产品简称开头，后加产品表名前缀，比如DSMP_T_RISK_XXX.

2） 对于设置了有效期的缓存，在数据具体失效时间上会通过加随机值错开时间，避免大量数据在同一时间失效、清理缓存导致的缓存雪崩现象。

* 缓存限制及数据淘汰策略

基于现阶段规划的缓存数据，缓存中心最大缓存设置为1G，但缓存不足时会触发数据淘汰，Redis支持六种数据淘汰策略

1） voltile-lru：从已设置过期时间的数据集（server.db[i].expires）中挑选最近最少使用的数据淘汰

2） volatile-ttl：从已设置过期时间的数据集（server.db[i].expires）中挑选将要过期的数据淘汰

3） volatile-random：从已设置过期时间的数据集（server.db[i].expires）中任意选择数据淘汰

4） allkeys-lru：从数据集（server.db[i].dict）中挑选最近最少使用的数据淘汰

5） allkeys-random：从数据集（server.db[i].dict）中任意选择数据淘汰

6） no-enviction（驱逐）：禁止驱逐数据

基础平台采用第1种 “voltile-lru”策略，即从已设置过期时间的数据集中挑选最近最少使用的数据进行淘汰。

## 1.1. **业务流程**

基础平台运行过程中涉及多种业务流程，以下从Web请求、系统升级、数据同步、帐号改密等主要场景对基础平台的业务流程进行描述。

1. 

2. 

3. 

3.1. 

3.2. 

3.3. 

3.4. 

3.5. 

### 3.5.1. **认证鉴权机制**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps9.png)

针对浏览器、外部API和后台服务发起的业务请求，API网关把业务请求统一转发给认证中心的票据服务进行票据验证，只有携带合法票据的请求会被转发给相应的服务，由相应的服务提供响应。一次完整的业务请求流程如下：

1） API网关接收业务请求，把业务请求转发给认证中心的票据服务；

2） 票据服务进行判断有效性校验，分以下三种情况

Ø 浏览器访问的场景，跳转认证中心登录界面完成用户和密码输入并提交认证请求到认证中心身份认证服务进行身份认证，继续步骤3和4；

Ø 外部API访问的场景，转发请求到认证中心身份认证服务进行身份认证，继续步骤3和4；

Ø 后台服务访问的场景，转发请求到认证中心身份认证服务进行身份认证，继续步骤3和4；

3） 身份认证成功，返回认证结果；

4） 票据服务根据认证结果生成合法票据，并把携带票据和校验结果的请求返回给调用者；

5） 浏览器、外部API和后台服务携带合法票据请求API网关，API网关转发转发请求到认证中心的票据服务；

6） 票据服务校验票据合法，把携带票据和校验结果的请求返回给API网关（通过状态判断，不再请求认证中心）

7） API网关根据票据校验结果把请求路由到用户管理服务完成业务操作；

8） 用户管理需要请求资源管理的API，携带票据发送请求到API网关；

9） API网关转发携带票据的请求给票据服务；

10） 票据服务校验票据合法，返回校验结果给API网关（通过状态判断，不再请求认证中心）；

11） API网关把请求路由到资源管理服务完成业务操作。

通过浏览器登录平台时通过界面输入用户和密码换取票据后执行后续业务请求；外部API和后台服务需要携带用户身份请求API网关换取票据后执行后续业务请求，不同的请求对API网关透明，身份认证、票据生成、鉴权机制相同。

平台为浏览器、外部API和后台服务的访问分配不同的用户，用于区分不同来源的业务请求，给外部API和后台服务分配的用户控制禁止通过浏览器登录。

### 3.5.2. **升级流程**

系统升级考虑单机部署和分布式部署情况下的升级，以下以分布式情况下的升级为准进行描述，单机部署升级流程相同。

系统升级涉及系统升级前端、后端、消息中心和后台升级服务。

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps10.png)

1） 系统升级前端上传升级包，完成升级文件前端校验，调用系统升级后端服务，由后端服务完成升级包上传和存储；

2） 后端服务发送升级通知到消息中心；

3） 后台升级服务订阅升级通知；

4） 后台升级服务从缓存中心获取系统管理服务地址，调用系统升级后端的API下载升级包到本地，执行停容器、备份历史软件、根据本机安装的组件拷贝新软件覆盖安装、启容器等动作来实现相关服务升级；

5） 后台升级服务调用系统升级后端上报升级结果、版本号、升级详情；

6） 系统升级前端通过API轮询升级进度和升级结果。

以上流程中，前端、后台升级服务调用后端的API需要经过API网关，以上流程中未体现这些细节。

系统配置（网络、时间、电源）流程与系统升级类似，只是没有升级包下载动作。

### 3.5.3. **能力组件数据同步**

基础平台支持两种方式和能力组件对接实现数据同步，一种方式是拉的方式，由能力组件适配平台，能力组件主动到平台获取变更的数据，另一种方式推动的方式，由平台适配能力组件的接口，平台主动把变更的数据推送给能力组件。

Ø 拉的方式

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps11.png)

能力组件直接到消息中心订阅数据变更事件，事件中的信息能满足能力组件需求情况下，无需执行步骤3，否则能力组件需要根据事件中的对象ID，调用数据同步服务为能力组件开发的统一API，数据同步服务调用后端服务的原子API把查询到的各类原子数据进行业务封装后通过统一API返回数据。

Ø 推的方式

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps12.png)

由数据同步组件订阅数据变更事件，事件中的信息能满足数据同步需求情况下，数据同步服务调用后端服务的原子API，否则数据同步服务需要根据事件中的对象ID，调用后端服务的原则API把获取到的数据进行封装后，按照能力组件的API主动向能力组件推送数据。

### 3.5.4. **帐号改密**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps13.png)

基础平台和堡垒机对于改密都是异步调用，所以基础平台上发起改密动作后，把帐号状态置为改密中，数据库还是保存老密码，不影响帐号正常使用。

目标资源改密完成后堡垒机会进行密码拨测，保证改密结果，拨测完成后，堡垒机回调数据同步服务接口，通知改密结果，根据改密结果修改帐号状态、修改密码、同步帐号给堡垒机等能力组件，保持数据一致。

注：使用改密中的帐号登录时，如果目标资源还未完成改密，可能导致登录失败。

### 3.5.5. **主备**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps14.png)

前端调用系统管理服务API发起主备配置操作，系统管理服务向消息中心发送主备配置命令，后台主备服务订阅消息执行主备动作：主备数据同步，数据同步后通过主备事件处理程序上报主备切换完成事件给消息中心，同时通过API上报给系统管理后端用于界面展示，通知服务订阅该事件，并通过短信服务或邮件服务给管理员发送通知。

Ø 服务状态监控

系统运行过程中，服务状态监控程序（HA）监控相关服务的状态，并根据监控的服务的状态综合判断是否需要执行主备切换。

服务状态监控来源于两个方面：

1） 从守护进程获取服务状态，获取拉取三次都不成功的服务的状态

2） 由服务状态监控程序执行业务拨测进行判断。针对数据库真正执行一条sql检查pg的可用性、连接是否占满；针对API网关真正执行一次http请求，检查网关是否有响应。

主备切换的判断依据是以下服务中任何一个启动三次失败或业务拨测失败则进行主备切换。

1） API网关

2） 认证中心

3） 用户管理

4） DB

5） 消息中心

除以上服务外，其他服务异常时不会进行准备切换，依赖系统组件监控模块进行监控并人工参与来恢复服务。

Ø 主备数据同步

主备配置完成或主备切换完成后，会利用切换后的主机的数据覆盖备机的数据，达到主备数据一致的效果。

正常运行过程中心，主机数据变更时会利用pglogical准实时地、主动推送数据到备机。

Ø 主备事件处理

把服务状态监控结果、主备数据同步结果及问题以事件的形式上报到消息中心、上报给系统管理，分别为短信邮件通知、日志记录、系统组件状态监控提供基础。

说明：主备只考虑单机部署的情况，不考虑分布式部署和云化部署。

### 3.5.6. **系统组件管理**

系统组件管理实现系统各服务状态监控、性能监控、服务启停和服务运行日志下载功能。

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps15.png)

Ø 服务状态监控

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps16.png)

服务状态监控通过守护进程supervisor实现系统所有组件的在线状态监控，提供服务是否在线的信息。服务状态监控流程如下：

1） 守护进程supervisor通过配置，主动监控每个服务的状态，包括自己开发的服务和引入的第三方服务比如缓存中心Redis；

2） 系统配置服务通过定时任务，周期性从守护进程查询服务状态；

3） 系统配置服务把获取到的服务状态信息发送到消息中心；

4） 系统管理服务从消息中心订阅服务状态信息；

5） 系统管理服务把订阅到的服务状态信息存入DB；

6） 前端通过系统管理服务API查询服务状态，实现服务状态监控，呈现系统组件状态； 

Ø 服务性能监控

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps17.png)

服务性能监控监控的是当前服务所在的服务器的性能指标，由每台服务器上部署的系统配置服务获取服务器的性能指标上报给系统管理，包括内存、CPU和磁盘使用。

Ø 服务启停

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps18.png)

当系统服务异常时，第一道防线由守护进程负责服务的重启，如果重启三次失败则服务在前端的表现为停止，需要人工参与服务启动。

由系统管理发送服务重启命令给消息中心，系统配置服务通过订阅消息中心的命令实现对服务的启停。

Ø 服务运行日志下载

当服务异常时，可通过前端界面下载每个服务的系统运行日志进行问题排查，下载的系统运行日志需要加密，并且可指定下载指定时间范围内的日志文件。

### 3.5.7. **能力组件管理**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps19.png)

能力组件管理实现能力组件地址配置和能力组件状态监控。

能力组件地址配置后会把能力组件信息写入缓存中心，定时任务从缓存中心读取数据、访问能力组件的指定地址的接口获取能力组件的性能指标，并根据性能指标判断能力组件状态是否在线。

### 3.5.8. **短信邮件通知**

通知服务负责订阅各服务产生的事件，把事件转化为实际需要发送的通知，并以事件的形式经由消息中心给到短信服务、邮件服务完成事件发送。

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps20.png)

以用户改密事件为例，短信邮件通知流程如下

7） 用户管理服务完成改密后发送改密事件；

8） 通知服务订阅改密事件；

9） 通知服务调用用户管理服务的API，查询用户改密通知的模板后，根据模板组装通知内容；

10） 通知服务把具体的通知内容、发送地址（手机、邮箱）以事件的形式发送给消息中心；

11） 短信服务订阅短信通知事件、邮件服务订阅邮件通知事件，完成短信通知或邮件通知。

### 3.5.9. **服务发现&注册**

平台通过服务主动上报的方式实现服务发现和注册。

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps21.png)

服务发现、注册及使用流程如下：

1） 各个服务通过集成通用模块，在服务启动时主动上报服务信息给zookeeper，上报的服务信息包括服务名称、URL地址。zookeeper通过监控服务的心跳实现服务准实时监控，当服务下线时zookeeper会取消该服务的信息，达到服务发现并掌握服务实时状态的效果。

2） 鉴权服务auth-server主动从zookeeper查询服务信息（因为traefik和zookeeper直接交互存在问题，所以引入auth-server实现服务信息查询）；

3） API网关traefik调用鉴权服务提供的API，周期性轮询所有服务信息，并把服务信息缓存在内存中，供API网关做服务路由时使用；

## 1.2. **静态架构**

1. 

2. 

3. 

3.1. 

3.2. 

3.3. 

3.4. 

3.5. 

3.6. 

### 3.6.1. **前端代码结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps22.jpg) 

以src/app/routes/system为例，对组件下级目录规划如下

|   |   |
|---|---|
|service|所有访问后台的service方法存放目录|
|statis-data|存放一些前端的基本配置，比如key-v的映射关系，键值等信息|
|system-list|系统管理下子菜单的具体内容|
|system.component.*|系统管理模块的母版页，所有内容都会经过这个页面，配置系统管理的菜单栏链接具体子菜单|
|system*module*|系统管理模块的路由配置管理文件，与系统管理相关的所有url,外部引用的私有组件引入位置（只引用系统管理部分的私有组件，如FormsModule,DatePipe,ConfirmInfoComponent等每个模块都有可能使用的公共组件在父级路由文件里引用）|

### 3.6.2. **后端代码结构**

所有的后端代码都存放于backend目录下，各子工程平级并且不允许代码依赖,数据交互依赖 API接口和消息总线。

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps23.jpg) 

各服务子目录如下：

|   |   |
|---|---|
|工程名|说明|
|platform-user-service|用户管理|
|platform-resource-service|资源管理|
|platform-system-service|系统管理|
|platform-system-config-service|系统配置服务|
|platform-upgrade-service|升级服务|
|platform-notice-service|通知服务|
|platform-email-service|邮件服务|
|platform-sms-service|短信服务|
|platform-log-service|日志服务|
|platform-sync-service|数据同步服务|
|platform-schedule-service|定时任务|
|platform-ha-service|主备服务|
|platform-collect-service|帐号采集服务|
|platform-pwd-service|帐号改密服务|
|platform-base-common|全局公共类,如分页,全局状态码..|
|platform-base-common-utils|全局公共工具类,如时间,日期处理类|
|产品名称-子系统名称-service|其他产品扩展工程|

Ø 单个服务的工程包结构

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps24.jpg) 

说明：

1、有通用的util放置到platform-base-common-utils工程中

2、框架通用类请放置到platform-base-common工程中

3、domain的实体类必须保持干净，不允许有额外字段和逻辑，数据校验参数接收通过bo完成，返回前端数据通过vo完成，bo和vo一进一出。

4、一些与项目业务本身无关的封装可以放到manager中

5、基础平台开源组件、依赖包的引入必须通过SE评审，开发人员不能擅自引入，同时基础平台对引入的开源组件和依赖包必须保证版本统一，避免不同服务依赖不同版本的外部资源而导致服务冲突。

Ø 产品扩展

其他项目集成基础平台在backend目录下新起对应的扩展服务

1. 工程命名以 {项目名}-{子工程名}-service来新建服务

2. 工程代码参考上文描述结构来新建工程

3. 禁止代码级依赖基础平台相关服务，数据交互以API调用和消息总线来实现。

4. 例外:platform-base-common, platform-base-common-utils 相关jar可以代码级依赖。

### 3.6.3. **自动化构建和打包**

基础平台使用Jenkins实现自动化构建和打包，Jenkins可通过控制台操作项目创建、配置和自动化构建，以下从Jenkins安装、后端服务构建、前端服务构建、打安装包几个方面进行说明。

Ø Jenkins安装

在打包机上新建centos操作系统的虚拟机，在虚拟机上部署Jenkins，Jenkins安装软件和详细安装步骤参考官方文档。Jenkins配置要求如下

l 2G以上可用内存

l 100G以上可用磁盘空间

l JDK1.8

Ø 后端服务构建

为每个后端服务创建任务并指定项目名称，因为我们使用maven，所以后端服务选择构建maven项目。

源码管理步骤指定基础平台相应服务对应的SVN地址并配置SVN的帐号和密码。

Build步骤指定pom文件和mvn命令，比如pom文件默认为“pom.xml”、mvn命令为“clean install -DskipTests”。

其他操作步骤保持默认即可，也可以根据业务需要进行配置，比如工程有依赖时在构建触发器章节选择“Build after other projects are built”并指定依赖的前序工程。

Ø 前端构建

为前端服务创建任务并指定项目名称，基础平台前端使用angular框架，选择Freestyle project项目。

构建步骤指定前端服务打包命令，比如“source /etc/profile && cnpm install && ng build --prod”

其他操作步骤配置和后端服务构建相同。

Ø 打安装包

所有服务构建好以后，需要把所有服务打成安装包，需要在SVN上提前规划好安装包的框架，包括安装脚本、编译脚本、依赖包、自定义脚本等，详细参考3.6.4安装包结构。

同样创建任务并指定项目名称，选择Freestyle project项目。

源码管理步骤，指定SVN上安装包框架地址并配置帐号和密码。

构建步骤，把每个服务已经构建好的包按照安装包框架要求拷贝到指定的目录下。

构建后操作步骤，指定ant命令和安装包框架下的build脚本。

通过以上配置即可实现基础平台自动化打包，打好的安装包统一存储在打包机上，需要定时打包时在构建触发器步骤配置周期性时间即可。

对于多品牌的情况，多品牌涉及到不同的logo、icon等静态文件，在SVN上可以为每个品牌创建一个安装包架构，同样在Jenkins上为每个品牌创建一个打安装包的项目指定对应的SVN地址即可

### 3.6.4. **安装包结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps25.jpg) 

### 3.6.5. **文件系统规划**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps26.jpg) 

## 1.3. **部署形态**

基础平台通过容器化方式部署，支持单机部署、分布式部署和云化部署。

1. 

2. 

3. 

3.1. 

3.2. 

3.3. 

3.4. 

3.5. 

3.6. 

3.7. 

### 3.7.1. **单机****部署**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps27.png)

用户管理、认证中心、资源管理、系统管理、数据同步、系统日志服务、邮件服务、短信服务等前后台服务每个服务都运行在一个容器中，系统配置服务、升级服务和DB运行在宿主机上。

用户管理、认证中心、资源管理、系统管理等服务的数据库独立，以不同的实例跑在同一个数据库软件上，数据库软件运行在宿主机上。

系统管理通过消息中心下发系统配置事件给系统配置服务，由系统配置服务完成对宿主机的时间配置、网络配置和电源配置。

系统管理完成升级包上传、校验和存储，通过消息中心通知升级服务，升级服务从指定服务器的指定路径下载升级包、完成对本机服务升级。

### 3.7.2. **分布式部署**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps28.png)

分布式部署的情况下，优先安装DB、缓存中心和消息中心，在安装其他服务的时候必须指定DB、缓存中心和消息中心的地址。

各服务安装后，主动上报自身地址到缓存中心，由缓存中心统一维护所有服务的地址（DB地址除外），供API网关路由查找各服务时使用，同时向消息中心上报服务地址。

Ø 服务地址变更

系统管理所在的服务器，通过前端界面修改本服务器地址，驱动后台系统配置服务完成本服务地址变更、向消息中心上报地址变更事件、更新缓存中心缓存的本服务的地址。

其他服务所在的服务器，通过后台管理菜单修改服务器地址，同样驱动系统配置服务完成本服务器的地址变更，其他逻辑与界面修改地址相同。

当服务地址变更时，被通知者的系统配置服务订阅消息中心其他服务地址变更事件，并更新本地的host文件，用于各服务交互通信时使用。各服务通信时使用域名进行通信，不使用IP地址，避免IP地址变更导致的频繁切换访问地址。

Ø 部署约束

分布式部署情况下，以下服务要和系统管理部署在同一个服务器上

1) 系统日志服务，系统管理提供管理界面需要下载系统日志服务在本机记录的日志。

2) NTP时间服务器和系统管理部署在一台服务器上，方便通过界面配置NTP。

Ø 时间配置

系统管理所在的服务器安装NTP时间服务器，通过系统管理可以实现以下几种方式的时间配置。

1） 以国家授权中心时间为准

2） 以我们部署的NTP服务器时间为准

3） 手工配置时间

分布式部署情况下，其他服务器作为客户端同步系统管理所在的服务器的时间，无论以上哪种方式配置时间，都可以达到分布式的各服务器时间一致的效果。

Ø 安全性考虑

分布式部署情况下，消息中心和缓存中心考虑通过IP绑定和使用非默认端口的方式实现安全控制，防止外部地址非法访问和恶意扫描。

### 3.7.3. **微服务云化部署**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps29.png)

微服务云环境部署情况下，系统配置由云平台提供，各服务的升级通过镜像方式升级，无需部署系统配置服务和升级服务，同样数据库软件由云平台提供。

## 1.4. **版本升级**

基础平台版本升级从版本号规划、软件升级机制、DB升级机制三方面进行考虑。

1. 

2. 

3. 

3.1. 

3.2. 

3.3. 

3.4. 

3.5. 

3.6. 

3.7. 

3.8. 

### 3.8.1. **版本规划**

版本格式：主版本号.次版本号.修订号，版本号递增规则如下：

主版本号：当做了无法向下兼容的修改时修改主版本号；

次版本号：当做了向下兼容的功能性变更时修改次版本号；

修订号：当做了向下兼容的BUG修正时修改修订号；

基础平台第一个版本，版本号规划为1.0.0。

### 3.8.2. **软件升级****机制**

各个服务软件升级时，升级流程会先停服务、备份历史软件到备份目录、拷贝新软件覆盖软件安装目录、再启动容器实现服务升级。

升级后，如果验证服务异常，则可以手工恢复历史软件来实现升级回退。

考虑到磁盘空间的使用，备份目录只保留最近一次历史软件的备份。

### 3.8.3. **DB升级机制**

DB升级机制没有备份恢复，DB升级通过设置约束向下兼容来规避升级回滚的需求。DB变更遵循以下约束：

Ø 新增表

新增表时，在升级脚本中通过SQL完成表创建、数据初始化和表约束配置。

Ø 删除表

DB升级，不允许删除表。

Ø 新增字段

新增字段时，在升级脚本中通过SQL完成字段新增、类型设置、必填项时的默认值设置

Ø 修改字段

DB升级，不允许修改字段，比如字段类型、字段约束，对于字段类型修改只能新增一个字段并把老字段的值拷贝到新字段来使用；字段约束通过业务控制或默认值实现。

Ø 删除字段

DB升级，不允许删除字段。

Ø 修改初始化数据

新增、修改、删除初始化数据时，同样在升级脚本中通过SQL完成。

说明：任何版本的DB升级，必须基于上版本DB的基础上对DB进行修改，比如1.0.0有一条初始化数据，1.0.1版本删除了该数据，1.0.2该数据时需要基于1.0.1执行insert语句，而非基于1.0.0执行update。

### 3.8.4. **跨版本升级**

以上的升级机制能够满足次版本号和修订号的跨版本升级。

## 1.5. **产品集成**

DSMP或新产品在基础平台基础上集成产品的特性功能，比如授权、风险中心等。

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps30.png)

Ø 前端

在基础平台的前端工程中规划产品目录，新增产品特性的前端功能，并把相应功能注册到前端框架中；特殊情况可能需要对基础平台前端业务进行修改，比如在用户管理列表增加授权入口，这种情况下需要对基础平台相应前端进行修改，这种修改放在产品侧维护，基础平台不关注。

Ø 后端

后端根据产品特性需求新增一个或多个独立工程，并搭配多个相互独立的DB，产品打包时把基础平台和产品特性工程打包到一起。

Ø 消息中心和缓存中心

消息中心和缓存中心不影响。

Ø 后台服务

后台服务根据产品需求新增相应的后台服务，不允许修改基础平台已有的后台服务。

守护进程新增对产品特性服务进行监控。

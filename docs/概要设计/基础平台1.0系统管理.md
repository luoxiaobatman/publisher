---
created: 2023-09-20
number headings: first-level 2, start-at 1, max 6, 1.1-
title: 基础平台1.0系统管理
author: 罗潇
cssclass: wideTable
first-level: 1
pdf-filename: 基础平台1.0系统管理
platform: true
category: 概要设计
---

### 1.1.1 **系统管理**

#### 1.1.1.1 **能力组件****管理**

##### 1.1.1.1.1**功能描述**

能力组件支持类型2018版VBH服务器、ASCG服务器

能力组件管理实现能力组件地址配置和能力组件状态监控，产生能力组件变更事件。

##### 1.1.1.1.2**功能设计**

###### 1.1.1.1.2.1**获取能力组件列表**

1、 能力组件列表页面展示数据：组件名称、组件地址、组件类型、调用编号、秘钥、状态、cpu占用率、内存使用率、磁盘利用率、操作。

2、 二级列表展示堡垒机能力组件下挂载的相关应用发布服务器信息。

###### 1.1.1.1.2.2**新增能力组件**

1、能力组件类型可以为2018版VBH服务器、ASCG服务器。

2、组件地址为ip+端口，组件地址可以为IPV4地址也可以为IPV6地址，新增时进行组件地址校验。

3、调用者编号和秘钥为能力组件上配置的调用能力组件接口需要的调用者编号和秘钥，鉴权使用。

4、负责人，最多选择10个用户，用于能力组件监控告警时发送相应的短信或邮件给负责人。

5、新增能力组件之前先对能力组件的地址进行拨测，确保能力组件地址、端口、秘钥配置都为正确的信息。

6、产生能力组件新增成功事件，数据同步服务订阅事件，做基础数据同步到能力组件操作。针对ASCG，需要向ASCG同步组织数据,用户数据。对于18版堡垒机，需要同步组织机构数据、用户数据、资源组数据。

7、适配能力组件老版本对基础平台接口的调用。

1.1.1.1.2.2.1**能力组件新增前的拨测**

1、 新增能力组件保存按钮之前提供一个拨测按钮，调用能力组件拨测接口，返回能力组件是否能正常连通信息。

2、 新增按钮逻辑很单独，只负责新增能力组件，不会去判断是否拨测成功

1.1.1.1.2.2.2**新增****2****018版****V****BH能力组件**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps63.jpg) 

3、 将前端传来的能力组件信息存入数据库中。

4、 发送能力组件新增事件到消息中心。

5、 ~~待定~~~~：~~~~同步审批规则到当前新增的~~~~V~~~~BH~~~~。~~

6、 定时组件调用系统管理能力组件查询接口,获取全部能力组件接口密钥信息,调用能力组件状态接口获取设备状态、cpu使用率、磁盘使用率、内存使用率上报给系统管理服务

7、 定时组件调用系统管理能力组件查询接口,获取全部能力组件接口密钥信息,调用能力组件版本查询接口上报给系统管理服务。

8、 定时组件上报能力组件状态信息后,系统管理服务根据上报的信息来判断是否发送告警事件(根据系统参数配置:CPU告警阈值,磁盘阈值,内存阈值)

9、 定时组件调用18版堡垒机获取挂载的应用发布服务器信息，以及挂载的文档管控信息。

10、 定时组件将应用发布服务器信息和文档管控信息上报给系统管理服务，系统管理服务将应用发布服务器信息和文档管控信息存入能力组件表中。应用发布服务器和文档管控与父级堡垒机关系由system_parent_id字段体现。

1.1.1.1.2.2.3**新增****A****SCG能力组件**

1、 将前端传来的能力组件信息存入数据库中。

2、 发送能力组件新增事件到消息中心。

3、 定时组件调用系统管理能力组件查询接口,获取全部能力组件接口密钥信息,调用能力组件状态接口获取设备状态、cpu使用率、磁盘使用率、内存使用率上报给系统管理服务。

4、 定时组件调用系统管理能力组件查询接口,获取全部能力组件接口密钥信息,调用能力组件版本查询接口上报给系统管理服务。

5、 定时组件上报能力组件状态信息后,系统管理服务根据上报的信息来判断是否发送告警事件(根据系统参数配置:CPU告警阈值,磁盘阈值,内存阈值)。

###### 1.1.1.1.2.3**修改能力组件**

修改能力组件同新增逻辑基本一致。

###### 1.1.1.1.2.4**删除能力组件**

1、 删除能力组件下挂载的能力组件数据。

2、 删除能力组件表中的数据。

3、 删除能力组件状态监控表中与能力组件id关联的监控信息。

4、 删除发送删除事件,通知能力组件已被删除

###### 1.1.1.1.2.5**能力组件****状态上报接收****接口**

定时组件调用能力组件状态接口获取设备状态、cpu使用率、磁盘使用率、内存使用率和版本查询接口,上报给系统管理服务入库,如果上报的状态信息超过系统参数配置的阈值,发送能力组件告警事件,系统通知服务完成后续通知动作

###### 1.1.1.1.2.6**能力组件关联资源组**

能力组件关联资源组

1. 目前仅支持2018版堡垒机、ASCG能力组件关联资源。

2. 当能力组件关联资源组的时候，会产生事件，下发资源同步kafka消息。数据同步服务接收到数据同步消息，然后进行相应的资源、协议、帐号同步到能力组件。

3. 将能力组件与资源组的关联关系写入数据库，

4. 能力组件取消与资源组的关联的时候，需要删除能力组件上对应的资源组下的资源信息

5. 需要提供资源组关联的能力组件查询接口,

6. 资源关联最优性能能力组件接口(下个版本考虑)

7. 资源组下资源变更所在资源组的时候，数据同步组件根据接收到资源变更消息，删除资源在原来资源组关联的能力组件下的信息，然后将当前资源信息放到新的资源组关联的能力组件下。

8. 资源组变更的时候，将原来的资源组及其子节点所关联的能力组件全部删除掉，然后将当前节点及其子节点都关联至拖拽的资源组关联的能力组件。例：有二级资源组1关联了能力组件A、B、C，二级资源组1下的三级资源组1关联了能力组件A，有二级资源组2关联了能力组件D、E、F、G，将二级资源组1拖拽到二级资源组2的时候，需要将二级资源组1及其子节点三级资源组1关联的能力组件上的当前资源组下的资源信息全部删除掉，然后再将二级资源组1及其子节点三级资源组1关联上二级资源组2关联的能力组件D、E、F、G，即当前节点及其子节点默认继承父节点关联的所有的能力组件，然后将当前二级资源组1及其子节点三级资源组1下的资源同步至D、E、F、G能力组件。

9. 能力组件与资源组的绑定关系，只用绑定父节点即可，子节点默认继承绑定的父节点绑定的能力组件。

###### 1.1.1.1.2.7**能力组件关联组织机构**

待定：下个版本考虑

##### 1.1.1.1.3**数据结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps64.jpg) ![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps65.jpg)

#### 1.1.1.2 **系统主备管理**

##### 1.1.1.2.1**功能描述**

1、 前端调用系统管理服务API发起主备配置操作。

2、 系统管理服务向消息中心发送主备配置消息。

3、 后台主备服务订阅消息执行主备动作。

4、 后台主备服务发送主备动作执行结果事件。

5、 后台主备服务调用系统管理服务主备配置执行结果保存接口、对执行结果入库。这里入库的是主备配置结果日志信息，并不是主备状态信息。系统管理查询HA服务的接口实时获取(和架构差异)

6、 通知服务订阅主备动作执行结果事件，并通过短信服务或邮件服务给管理员发送通知。

##### 1.1.1.2.2**主备流程**

###### 1.1.1.2.2.1**配置主机热备**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps66.jpg) 

1、 主机前端界面配置热备主机，调用系统服务API接口。

2、 系统服务响应前端，返回消息热备主机正在配置中。

3、 系统服务发送配置热备主机事件到消息中心。

4、 后台主备服务主备事件处理模块订阅配置热备主机事件。

5、 后台主备服务主备事件处理模块使用命令行调用后台主备服务主备配置切换模块脚本。

6、 后台主备服务主备配置切换模块检查命令行参数，将当前设备配置为热备主机。

7、 后台主备服务主备配置切换模块同步返回配置热备主机结果给后台主备服务主备事件处理模块。

8、 后台主备服务主备事件处理模块发送配置热备主机结果事件到消息中心。

9、 后台主备服务事件处理模块调用系统服务配置热备主机结果处理接口。

10、 系统服务将配置热备主机结果存入数据库。

11、 通知服务订阅配置热备主机结果事件。

12、 通知服务通过邮件服务、短信服务发送通知。

###### 1.1.1.2.2.2**备机申请加入主备**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps67.jpg) 

备机端逻辑

1、 备机前端页面配置备机，调用系统服务API接口。

2、 系统服务响应备机前端，返回消息备机申请加入主机正在配置中。

3、 系统服务发送备机申请加入主备事件到消息中心。

4、 后台主备服务主备事件处理模块订阅备机申请加入主备事件。

5、 后台主备服务主备事件处理模块使用命令行调用后台主备服务主备配置切换模块脚本。

6、 备机后台主备服务主备配置切换模块向主机后台主备服务主备配置切换模块发送加入热备申请请求，检查命令行参数，将当前设备配置为热备主机。

7、 主机后台主备服务主备配置切换模块校验申请备机参数。

8、 主机后台主备服务主备配置切换模块同步返回校验执行结果成功或失败给备机后台主备服务主备配置切换模块。

9、 备机后台主备服务主备配置切换模块同步返回备机申请加入主备结果。

10、 后台主备服务主备事件处理模块发送备机申请加入主备结果事件到消息中心。

11、 后台主备服务主备事件处理模块调用系统服务备机申请加入主备结果处理接口。

12、 系统服务将备机申请加入主备结果存入数据库。

13、 通知服务订阅备机申请加入主备结果事件。

14、 通知服务通过邮件服务、短信服务发送通知。

主机端逻辑

1、 主机后台主备服务主备配置切换模块校验申请备机参数后，执行脚本，调用后台主备服务主备事件处理模块提供的热备事件处理http接口。

2、 后台主备服务主备事件处理模块发送备机申请加入主备结果事件到消息中心。

3、 后台主备服务主备事件处理模块调用系统服务备机申请加入主备结果处理接口。

4、 系统服务将备机申请加入主备结果写入数据库。

5、 通知服务订阅备机申请加入主备结果事件。

6、 通知服务通过邮件服务，短信服务发送通知。

###### 1.1.1.2.2.3**主机同意备机加入主备**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps68.jpg) 

主机端逻辑

1、 主机前端页面管理员同意设备加入主备，调用系统服务API接口。

2、 系统服务响应主机前端，返回消息备机加入主备正在配置中。

3、 系统服务发送主机同意备机加入主备事件到消息中心。

4、 后台主备服务主备事件处理模块订阅主机同意备机加入主备事件。

5、 后台主备服务主备事件处理模块使用命令行调用后台主备服务主备配置切换模块脚本。

6、 主机后台主备服务主备配置切换模块检查参数，处理主备逻辑。

7、 主机后台主备服务主备配置切换模块向备机后台主备服务主备配置切换模块发送备机申请加入热备确认结果请求。

8、 备机后台主备服务主备配置切换模块配置设备成为备机。

9、 备机后台主备服务主备配置切换模块同步返回配置备机结果给主机后台主备服务主备配置切换模块。

10、 主机后台主备服务主备配置切换模块同步返回主机同意备机加入主备配置结果。

11、 后台主备服务主备事件处理模块发送主机同意备机加入主备结果事件到消息中心。

12、 后台主备服务主备事件处理模块调用系统服务主机同意备机加入主备结果处理接口。

13、 系统服务将主机同意备机加入主备结果存入数据库。

14、 通知服务订阅主机同意备机加入主备结果事件。

15、 通知服务通过邮件服务、短信服务发送通知。

备机端逻辑

1、 备机后台主备服务主备配置切换模块配置设备成备机后，执行脚本，调用后台主备服务主备事件处理模块提供的热备事件处理http接口。

2、 后台主备服务主备事件处理模块发送主机同意备机加入主备结果事件到消息中心。

3、 后台主备服务主备事件处理模块调用系统服务主机同意备机加入主备结果处理接口。

4、 系统服务将主机同意备机加入主备结果写入数据库。

5、 通知服务订阅主机同意备机加入主备结果事件。

6、 通知服务通过邮件服务，短信服务发送通知。

###### 1.1.1.2.2.4**停止主机热备**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps69.jpg) 

主机端逻辑

1、 主机前端页面停止主机热备，调用系统服务API接口。

2、 系统服务响应主机前端，返回消息停止主机热备正在配置中。

3、  系统服务发送停止主机热备事件到消息中心。

4、  后台主备服务主备事件处理模块订阅停止主机热备事件。

5、 后台主备服务主备事件处理模块使用命令行调用后台主备服务主备配置切换模块脚本。

6、 主机后台主备服务主备配置切换模块检查参数，处理主机取消热备逻辑。

7、 主机后台主备服务主备配置切换模块向备机后台主备服务主备配置切换模块发送主机取消热备请求。

8、 主机后台主备服务主备配置切换模块同步返回主机取消热备结果。

9、 后台主备服务主备事件处理模块发送主机取消热备结果事件到消息中心。

10、 后台主备服务主备事件处理模块调用系统服务主机取消热备结果处理接口。

11、 系统服务将主机取消热备结果存入数据库。

12、 通知服务订阅主机取消热备结果事件。

13、 通知服务通过邮件服务、短信服务发送通知。

备机端逻辑

1、 备机后台主备服务主备配置切换模块处理备机取消热备逻辑。

2、 执行脚本，调用后台主备服务主备事件处理模块提供的热备事件处理http接口。

3、 后台主备服务主备事件处理模块发送备机取消热备结果事件到消息中心。

4、 后台主备服务主备事件处理模块调用系统服务备机取消热备结果处理接口。

5、 系统服务将备机取消热备结果写入数据库。

6、 通知服务订阅备机取消热备结果事件。

7、 通知服务通过邮件服务，短信服务发送通知。

###### 1.1.1.2.2.5**停止备机热备**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps70.jpg) 

主机端逻辑

1、 备机前端页面停止备机热备，调用系统服务API接口。

2、 系统服务响应备机前端，返回消息停止备机热备正在配置中。

3、 系统服务发送备机取消热备事件到消息中心。

4、 后台主备服务主备事件处理模块订阅备机取消热备事件。

5、 后台主备服务主备事件处理模块使用命令行调用后台主备服务主备配置切换模块脚本。

6、 备机后台主备服务主备配置切换模块处理备机取消热备逻辑。

7、 备机后台主备服务主备配置切换模块向主机后台主备服务主备配置切换模块发送备机取消热备请求。

8、 备机后台主备服务主备配置切换模块同步返回备机取消热备结果。

9、 后台主备服务主备事件处理模块发送备机取消热备结果事件到消息中心。

10、 后台主备服务主备事件处理模块调用系统服务备机取消热备结果处理接口。

11、 系统服务将备机取消热备结果存入数据库。

12、 通知服务订阅备机取消热备结果事件。

13、 通知服务通过邮件服务、短信服务发送通知。

主机端逻辑

1、 主机后台主备服务主备配置切换模块清理备机信息。

2、 执行脚本，调用后台主备服务主备事件处理模块提供的热备事件处理http接口。

3、 后台主备服务主备事件处理模块发送备机取消热备结果事件到消息中心。

4、 后台主备服务主备事件处理模块调用系统服务备机取消热备结果处理接口。

5、 系统服务将备机取消热备结果写入数据库。

6、 通知服务订阅备机取消热备结果事件。

7、 通知服务通过邮件服务，短信服务发送通知

##### 1.1.1.2.3**功能设计**

###### 1.1.1.2.3.1**主备配置约束条件**

1、 主备后台服务运行环境jdk1.8，python3.6，keepalived，pg10

2、 没有配置主备环境的服务器才能进行配置主机热备或者配置备机热备。

3、 配置了主机热备的服务器不能申请做为备机服务器。

4、 配置了备机热备的服务器不能申请做为主机热备服务器。

5、 配置了主机热备的服务器接收到多个备机申请加入主备的请求时，多个请求可以同时上报到主机，管理员可以同时同意多个备机加入主备的申请，但是最后只有一个能配置成功，当有一个配置成功了，其余的都会提示配置失败。

6、 主机拒绝备机申请加入，备机端会收到主机拒绝备机加入信息。

7、 只有相同版本及相同license信息(授权用户数,系统资源,应用资源数,权限点,授权类型)才能进行主备配置。具体比对校验方式为版本号和license信息。

8、 只有主备角色为主机的服务器才能处理备机申请加入主备请求，并且申请加入主备的主机ip必须为本机真实ip。

9、 主机为ipv4环境，备机为ipv6环境下主备配置不能成功，必须同为ipv4或ipv6。

10、 建立主备关系后备机离线会提示备机离线，主机还是主机并且正常运行。

11、 建立主备关系后主机离线又在线，此时备机变为主机，主机在线后角色为备机。

12、 建立主备关系后备机取消主备，主机还是主机并且正常运行。

13、 建立主备关系后主机取消主备，备机变主机，以前的主机没有任何主备角色。

14、 配置热备主机的热备配对号必须为1-255之间的一个整数，并且不能是当前网段已经使用过的热备配对号。

15、 本机配置热备的ip应该与本机配置热备的网卡中的ip一致。

###### 1.1.1.2.3.2**进入主备菜单**

1.1.1.2.3.2.1**功能描述**

进入主备菜单的时候，要先调用接口查看当前环境的主备相关信息。

如果当前环境没有配置主备，那么功能列表可以展示配置主机热备和配置备机热备按钮。

如果当前环境是热备主机，那么功能列表配置备机热备按钮必须置灰。

如果当前环境是热备备机，那么功能列表配置主机热备按钮必须置灰。

###### 1.1.1.2.3.3**查看主备信息**

1.1.1.2.3.3.1**功能描述**

查看当前环境主备的相关信息。

1.1.1.2.3.3.2**界面原型**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps71.jpg) 

1.1.1.2.3.3.3**功能设计**

主备信息并没有存储在数据库中，所以主备信息是从主备后台程序获取得到的。

待定：主备信息获取可以有两种方案。

第一种：前端调用系统服务接口获取主备信息，系统服务从数据库或缓存中查询主备信息。数据库或缓存中的主备信息由主备后台服务主备事件处理模块轮询获取，然后调用系统服务提供保存主备信息的接口更新主备信息。这样可能会存在一个问题，假如两台服务器A、B。A为主机，B为备机。A机上面数据库存储的主备信息为：当前主机的主备角色“MASTER”，主备本机的ip地址（172.16.98.110），主备其他机器的ip地址（172.16.98.111），主备切换的时候，假如存储主备信息的表需要同步，那么当前主机的主备角色MASTER这个信息没问题，但是主备本机的ip地址172.16.98.110就不对，应该是172.16.98.111；主备其他机器的ip地址应该是172.16.98.110。 只有等到下次主备后台服务主备事件处理模块轮询的时候才会更新主备信息到数据库或缓存中。假如存储主备信息的表不同步，那么B机器数据库中的主备数据可能还是当前角色为BACKUP，也是有问题的。要解决这个问题必须就在接收到主备切换事件的时候立马更新数据库中的数据。

**第二种****：****前端调用系统服务接口获取主备信息****，****系统服务调用主备后台程序接口实时获取主备状态信息****，****最后同步返回给前端****。**

###### 1.1.1.2.3.4**配置主机热备**

1.1.1.2.3.4.1**功能描述**

将当前设备配置为主机，并且可以控制主备服务开启或者关闭

1.1.1.2.3.4.2**界面原型**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps72.jpg) 

1.1.1.2.3.4.3**功能设计**

1、 只有未配置主备的服务器才能配置为主机热备。配置主机热备之前会判断当前服务器是否已经存在于主备角色中。

2、 配置主机热备的参数不会存储在数据库中，而是直接将主机参数传递给后台主备服务程序处理。

3、 如果当前服务器已经是主机热备角色，当点击配置主机热备按钮的时候，会将当前服务器主备信息回显到配置主机热备页面。但是只有主备服务开启\关闭下拉框可以操作，其他按钮置灰。就是说主机热备角色已存在的情况下，只能对主机热备进行停止操作。如果想更改当前服务器的主备配置，那么就将主机热备停止，恢复到没有配置主备的环境下。然后重新进行主备配置。

4、 浮动ip类型必须和本机配置主备使用ip类型一致，如同为ipv4类型和ipv6类型

5、 当前设备的所有服务健康状态都为健康的情况下才能进行主备配置

6、 浮动ip必须为未被使用的ip

###### 1.1.1.2.3.5**配置备机热备**

1.1.1.2.3.5.1**功能描述**

将当前设备配置为备机，并且可以控制主备服务开启或者关闭

1.1.1.2.3.5.2**界面原型**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps73.jpg) 

1.1.1.2.3.5.3**功能设计**

1、 只有未配置主备的服务器才能配置为备机热备。配置备机热备之前会先判断当前服务器是否已经存在于主备角色之中。

2、 配置备机热备的参数不会存储在数据库中，而是直接将备机参数直接传递给后台主备服务程序处理。

3、 配置备机热备只是申请加入主备环境，还需要主机热备管理员对当前配置备机热备申请进行处理，只有管理员同意申请加入主机热备，才算加入主备成功。

4、 如果当前服务器已经是备机热备角色，当点击配置备机热备按钮的时候，会将当前服务器主备信息回显到配置备机热备页面。但是只有主备服务开启\关闭下拉框可以操作，其他按钮置灰。就是说备机热备角色已存在的情况下，只能对备机热备进行停止操作。如果想更改当前服务器的主备配置，那么就将备机热备停止，恢复到没有配置主备的环境下。然后重新进行主备配置。

5、 主机ip使用类型必须和本机加入主备ip类型一致，如同为ipv4或者ipv6

6、 主机ip必须能够连通，否则无法使用

7、 主机和备机的版本号必须相同，否则不能加入主备

###### 1.1.1.2.3.6**主备****上报****事件接收**

1.1.1.2.3.6.1**功能描述**

系统服务接收主备后台程序上报的事件并进行相应处理。

1.1.1.2.3.6.2**界面原型**

无

1.1.1.2.3.6.3**功能设计**

主备后台服务在两种情况下会上报事件：

第一种情况：进行热备配置产生的结果上报；流程如下。

1、 主备后台服务主备事件处理模块接收到配置主机热备事件，然后调用主备后台服务主备配置切换模块配置主机热备。

2、 主备后台服务主备配置切换模块会同步返回结果给主备后台服务主备事件处理模块。

3、 主备后台服务主备事件处理模块调用系统服务主备上报事件接收接口。

4、 系统服务主备上报事件接收接口对上报的主备事件结果入库。

第二种情况：主备状态变化产生的主备事件上报；流程如下。

1、 主备状态发生变化时，主备后台服务主备配置切换模块会执行脚本，脚本内容为调用主备后台服务主备事件处理模块的http主备上报事件接收接口。

2、 主备后台服务主备事件处理模块提供的主备上报事件接收接口将会调用系统服务的主备上报事件接收接口。

3、 系统服务主备上报事件接收接口将会对每种事件都进行入库，会将主备上报事件那条数据设置为待办状态，所有待办状态的上报的事件都需要管理员处理

每种事件的处理方式如下： 

l 1、备机请求添加到热备主机，界面展示并通知相关人员。

l 2、主备备机离线，界面展示并通知相关人员。

l 3、数据同步异常，界面展示并通知相关人员。

l 4、主备主备机通讯异常，界面展示并通知相关人员。

l 5、主备机软件版本不一致，界面展示并通知相关人员。

l 6、主备主机同意备机加入申请，界面展示并通知相关人员。

l 7、主备主机拒绝备机加入申请，界面展示并通知相关人员。

l 8、主备备机取消主备，界面展示并通知相关人员。

l 9、主备备机上线，界面展示并通知相关人员。

l 10、主备主机取消热备，界面展示并通知相关人员。

l 11、备机变主机，界面展示并通知相关人员。

l 12、主机变备机，界面展示并通知相关人员。

通知方式由系统参数主备事件类型及主备事件通知模板决定。

相关人员为主备事件通知接收人配置的用户。

1.1.1.2.3.6.4**数据结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps74.jpg) 

###### 1.1.1.2.3.7**处理主备上报事件**

1.1.1.2.3.7.1**功能描述**

管理员对主备后台服务上报的主备事件进行处理，如备机申请加入主备事件处理。

1.1.1.2.3.7.2**界面原型**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps75.jpg) 

1.1.1.2.3.7.3**功能设计**

1、 管理员处理主备后台服务上报的主备事件，已处理的事件，操作栏那里就不会进行任何操作了。

2、 未处理的事件就有2种情况，第一种是备机申请加入主机热备事件的处理。对于这个事件只能进行同意或拒绝操作，不论是同意还是拒绝，都会调用系统管理api。然后系统管理下发管理员同意或拒绝的主备事件进行后续处理流程。第二种是非备机申请加入主备的事件的处理。由于这类事件不需要额外处理，管理员只需要标记为已处理就行了。

###### 1.1.1.2.3.8**相关服务监控**

1.1.1.2.3.8.1**功能描述**

系统运行过程中，服务状态监控程序监控相关服务的状态，并根据监控的服务的状态综合判断是否需要执行主备切换。

1.1.1.2.3.8.2**界面原型**

无

1.1.1.2.3.8.3**功能设计**

热备后台服务负责监控API网关、认证中心、用户管理、DB、消息中心。

守护进程监控服务状态，配置守护进程启动失败自动重试次数为3次，如果服务停了，守护进程会自动去拉取3次服务，如果拉取3次都没有成功，那么守护进程会将该服务状态设置为失败。

1、 热备后台服务服务状态监控模块每分钟进行一次任务调度监测服务状态,同时监听supervisor进程状态变更事件，将主备是否需要进行切换的信息写入HA服务内存中。

2、 热备后台服务服务状态监控模块首先调用守护进程接口获取API网关、认证中心、用户管理进程状态，如果其中一个服务状态为失败，那么将需要进行主备切换的信息写入HA服务内存(内部处理逻辑)。

3、 接下来热备后台服务服务状态监控模块进行api接口定时拨测判断API网关、认证中心、用户管理服务是否正常运行，拨测频率为10秒拨测一次，http接口返回超时就是API网关故障，返回503就是对应的服务不可用。如果拨测3次都没有成功，那么就将需要进行主备切换的信息写入HA服务内存。

4、 然后热备后台服务服务状态监控模块对db进行监控，每10秒执行一次pg连接命令和查询命令，判断是否连接占满或者DB数据库不可用，如果执行3次都是不可用或连接占满，那么就将需要进行主备切换的信息写入HA服务内存。

5、 接下来热备后台服务服务状态监控模块对消息中心进行监控，每10秒执行一次监听消息中心的端口是否正常，如果监听3次都是不可用，那么就将需要进行主备切换的信息写入HA服务内存。

6、 以上3、4、5步骤在子线程中同时进行，如果监控状态都为正常，那么就将不需要进行主备切换的信息写入内存。

7、 主备后台服务服务状态监控模块提供是否需要进行主备切换接口，接口读取内存中的是否需要进行主备切换信息，返回给调用方。主备后台服务主备配置切换模块每隔10秒调用一次主备后台服务服务状态监控模块提供的是否需要进行主备切换接口，如果需要进行主备切换，那么就进行主备切换。

8、 主备后台服务不上报服务状态给系统管理服务，当非主备部署的环境，就不会上报服务转台给系统管理服务。所以应该由系统配置服务上报服务状态给系统管理服务。

###### 1.1.1.2.3.9**主备事件通知接收人配置**

1.1.1.2.3.9.1**功能描述**

配置用户、短信或邮件通知所配置的用户主备状态切换等信息。

1.1.1.2.3.9.2**界面原型**

暂无

1.1.1.2.3.9.3**功能设计**

1、 主备上报事件接收列表的功能按钮那里提供按钮配置主备事件接收人，点击按钮展示一个tab页为主备事件通知接收人列表。

2、 列表默认勾选上原有配置了的用户，并且在列表最前方展示。

3、 如果要取消已经配置了的用户，取消列表用户的勾选就行了，如果要新增通知的用用户，勾选上点保存即可。

###### 1.1.1.2.3.10**版本信息提供**

1.1.1.2.3.10.1**功能描述**

提供基础平台系统版本信息供主备后台程序判断主备机系统版本是否相同。

1.1.1.2.3.10.2**界面原型**

无

1.1.1.2.3.10.3**功能设计**

1、 初始化安装系统的时候由初始化安装脚本写入系统版本号到文件。

2、 系统升级的时候由升级脚本写入系统版本号到文件。

3、 主备配置是同时会检查系统版本号和license授权信息是否一致

###### 1.1.1.2.3.11**同步的数据库表信息**

1.1.1.2.3.11.1**功能描述**

以json格式提供基础平台的postgresql数据库和表信息。

1.1.1.2.3.11.2**界面原型**

无

1.1.1.2.3.11.3**功能设计**

主备机间需要将基础平台的数据库数据进行同步，将需要同步的表名写入sync_etc_table.json文件提供给主备后台程序。

具体备份表：除了系统操作日志表、登录日志表、license数据表、热备事件表、配置备份表、系统升级日志表、系统在线用户表，其余表都需要同步。

详细配置参考《统一主备产品集成概要设计》。

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps76.png)

#### 1.1.1.3 **系统参数配置**

##### 1.1.1.3.1**功能描述**

提供相关系统参数配置功能。

##### 1.1.1.3.2**功能设计**

1、 系统参数在tab页展示(或单页分块展示)，根据系统参数的分类在不同tab页下展示(或单页分块展示)。

2、 系统参数项为内置数据，参数项的值是可以用户编辑修改的。

~~3、~~ ~~Redis缓存中存放系统参数数据。~~

4、平台参数类型目前支持登录配置、业务参数配置、系统配置、通知服务配置。

5、当文本框中带有占位符，提示清楚每个占位符代表的含义。

###### 1.1.1.3.2.1登录配置

1、 平台密码找回短信模板：文本框类型，用户找回密码短信模板。

2、 平台密码找回邮箱模板：文本框类型，用户找回密码邮件模板。

3、 平台登录短信通知模板：文本框类型，用户登录后短信通知模板。

4、 平台登录邮箱通知模板：文本框类型，用户登录后邮件通知模板。

5、 首次登陆是否改密:单选框类型(进系统后判断cas不处理)

6、 是否开启登陆验证码, 单选框类型 (cas实现)

7、 错误几次开启登录验证码 数字选择框(cas实现)

8、 系统配置的超时锁屏是否开启 单选框、多长时间锁屏数字选择框(进系统后判断cas不处理)

###### 1.1.1.3.2.2**业务参数配置**

1、 用户默认有效时间配置（/月）：数字选择器类型，用户默认有效时间，单位为月。

2、 用户有效期到期前多少天提醒（/天）：数字选择器类型，用户有效期到期前多少天对用户进行通知，单位为天。

3、 用户僵尸帐号配置：数字选择器类型，多少天未登录的用户算作僵尸帐号。

4、 资源僵尸帐号配置：数字选择器类型，多少天未登录的资源帐号算作僵尸帐号。

5、 用户有效期即将到期通知类型：复选框，短信通知、邮件通知。

6、 用户有效期即将到期短信通知模板：文本框类型。

7、 用户有效期即将到期邮件通知模板：文本框类型。

###### 1.1.1.3.2.3**系统配置**

1、 服务器CPU告警阈值：数字选择器类型，当CPU使用量超过这个百分比的时候进行告警

2、 服务器内存告警阈值：数字选择器类型，当内存使用量超过这个百分比的时候进行告警。

3、 服务器磁盘告警阈值：数字选择器类型，当磁盘使用量超过这个百分比的时候进行告警。

4、 磁盘清理阈值百分比：数字选择器类型，当磁盘使用量超过这个百分比的时候触发磁盘清理。（提示清理哪些东西）

###### 1.1.1.3.2.4**通知服务配置**

1、用户创建和改密通知类型：复选框，短信通知、邮件通知。

2、用户创建和改密短信通知模板：文本框类型。

3、用户创建和改密邮件通知模板：文本框类型。

4、用户密码重置通知类型：复选框，短信通知、邮件通知。

5、用户密码重置短信通知模板：文本框类型。

6、用户密码重置邮件通知模板：文本框类型。

7、主备事件通知类型：复选框，短信通知、邮件通知。

8、主备事件通知短信模板：文本框类型。

9、主备事件通知邮件模板：文本框类型。

10、能力组件监控告警通知类型：复选框，短信通知、邮件通知。

11、能力组件监控告警短信通知模板：文本框类型。

12、能力组件监控告警邮件通知模板：文本框类型。

##### 1.1.1.3.3**数据结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps77.jpg) 

#### 1.1.1.4 **系统****权限****管理**

##### 1.1.1.4.1**功能描述**

实现基于角色的权限管理功能，角色树形管理与控制。支持角色增删改查、分配用户、功能权限配置、数据权限配置。功能权限下的功能权限点以URL为粒度，实现URL鉴权，功能权限以功能为控制维度，一个功能权限可包含多个权限点。数据权限以组织机构、资源组为控制维度。角色支持分级管理，即父角色可以管理子角色，包括角色创建、修改、删除、分配权限等，为子角色分配的权限不能大于当前用户拥有的角色。一个用户可以关联多个角色，取权限的并集,系统默认初始化审计管理员、系统管理员、安全管理员三个角色，三个角色预置下列权限

审计管理员包括 系统登录日志，系统操作日志权限

系统管理员包括全部权限

Administrator 角色 不能删也不改 admin授权给他,admin 不能取消授权,admin可用修改名称,要展示

安全管理员包含用户管理和资源管理权限

预置的三个角色可以修改包含的权限以及修改和删除对应的角色信息；

默认初始化超级管理员用户，拥有所有权限，超级管理员用户 id 为 admin 且不可修改，如有需要用户名可通过数据库修改。 ~~普通账号~~~~角色~~~~和~~~~超级管理员角色~~

##### 1.1.1.4.2**功能设计**

###### 1.1.1.4.2.1**查询角色树**

查询角色树，查询当前用户拥有的角色树，只返回当前角色授权了的角色信息。

###### 1.1.1.4.2.2**新增/修改角色**

新增或修改已有角色，新增、修改角色不涉及角色的权限，仅修改角色数据本身。新增修改角色后均发送角色变更事件。

###### 1.1.1.4.2.3**删除角色**

删除角色，只能删除叶子节点的角色，删除后角色与用户的~~下~~~~用户~~关联关系一起删除~~将会对应删除~~~~，~~~~删除后~~~~角色下用户的权限同步改变~~、角色与功能权限点的关联关系一起删除、角色与数据权限的关联关系一起删除。删除角色后发送角色删除事件,有绑定关系不能删除,要有提示

###### 1.1.1.4.2.4**查询/更新角色下功能权限**

功能权限：权限点集合，可能包含多个权限点，与角色关联的始终是具体权限点，如果一个角色拥有某个功能权限关联的所有权限则这个角色就拥有这个功能权限

查询角色下功能权限指定角色及其下级角色所有的功能权限(过滤lincense不包含的权限点)，或更新角色下功能权限,更新角色功能权限时先检验当前系统license授权的权限是否存在,若不存在提示保存失败，更新角色下功能权限后发送角色功能权限变更事件

###### 1.1.1.4.2.5**查询/更新角色下数据权限**

查询~~获取~~或者更新角色下拥有的数据权限，查询的是指定角色及其下级角色所有的数据权限，更新的是指定角色本身的数据权限。更新时，先删除以前的角色数据权限关联数据，然后再添加指定的新的角色数据权限关联关系。更新角色下数据权限后发送角色数据权限变更事件。默认不配置数据权限不具备数据权限,如配置了任意一条数据权限只有配置的数据权限

###### 1.1.1.4.2.6**角色下用户查询/修改**

分页查询角色下的用户，角色下添加用户、删除用户，角色删除时，角色与用户、角色与各个权限的关联关系都会删除~~后~~。

###### 1.1.1.4.2.7**查询用户菜单树**

查询当前系统license授权的权限中当前用户要显示的菜单，按树形结构返回，根据用户的权限查询出功能权限，再根据功能权限及功能权限与菜单的关联关系查询出用户的菜单信息，最后根据菜单的上下级关系生成用户的菜单树，树的每个节点除了包含节点本身之外还包含当前节点级别的功能权限信息。比如以下树（树的字段名字未定，后面根据实际情况定，这里只是提供一个例子）：

|   |
|---|
|{<br><br>  "nodeList": [<br><br>    {<br><br>      "menuInfo": {<br><br>        "id": "platformconfiguration",<br><br>        "pid": "safemanager",<br><br>        "name": "平台配置"<br><br>      },<br><br>      "permissionGroups": [<br><br>        {<br><br>          "id": "platformconfiguration_platformconfiguration",<br><br>          "name": "平台配置"<br><br>        }<br><br>      ],<br><br>      "childNodes": [<br><br>        {<br><br>          "menuInfo": {<br><br>            "id": "resTool",<br><br>            "pid": "platformconfiguration",<br><br>            "name": "登录工具管理"<br><br>          },<br><br>          "": [<br><br>            { permissionGroups<br><br>              "id": "resTool_restool_update_res",<br><br>              "name": "工具修改资源"<br><br>            }<br><br>          ]<br><br>        }<br><br>      ]<br><br>    }<br><br>  ]<br><br>}|

###### 1.1.1.4.2.8 

##### 1.1.1.4.3**数据结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps78.jpg) 

#### 1.1.1.5 **系统日志管理**

##### 1.1.1.5.1**系统登录日志**

###### 1.1.1.5.1.1**功能描述**

日志内容包含登录用户、组织机构、时间、日志级别、源ip、日志类型、操作详情、登录结果，日志支持按照用户分权分域。产品考虑资源分权分域,后期考虑按资源维度分权分域

###### 1.1.1.5.1.2**功能设计**

1.1.1.5.1.2.1**日志查询**

可通过用户名、时间、源IP、登录结果、组织机构几个参数分页查询登录日志，分页大小可以指定。

##### 1.1.1.5.2**系统操作日志**

###### 1.1.1.5.2.1**功能描述**

日志内容包含用户名、时间、日志级别、源IP、操作类型、操作结果、组织机构，支持按照用户分权分域。

定时上报产生的日志不记录为操作日志。

日志翻译：

操作列提供详情按钮，弹框展示翻译页面，页面分上下两部分，上半部分展示翻译内容，下半部分展示原始报文。

翻译时，当为新增/删除时，翻译字段属性和字段值，翻译来源为通过查询表t_sys_log_translate获取。

当为修改时，分两部分展示，上部分展示修改前数据（翻译），下部分展示修改后数据（翻译）

通过module查询翻译字段，根据属性name进行匹配，匹配上之后则替换之前的值，未匹配或出现异常，则移除该属性。即只展示翻译表里配置的属性

###### 1.1.1.5.2.2**功能设计**

1.1.1.5.2.2.1**日志查询**

可通过用户名、时间、日志级别、源IP、日志类型、操作详情、组织机构几个参数分页查询登录日志，分页大小可以指定。

##### 1.1.1.5.3**系统日志**

###### 1.1.1.5.3.1**功能描述**

程序内部产生的日志称为系统日志

目前主要包括以下日志：

同步日志

配置备份日志

发送短信、邮件日志

列表展示如下信息：

时间、模块、对象、类型、结果、日志级别、内容

列表默认按照修改时间降序排序

模糊查询按照对象进行查询

高级查询提供按照时间段、模块、对象、类型、结果、日志级别进行查询

###### 1.1.1.5.3.2**功能设计**

#### 1.1.1.6 **系统配置**

##### 1.1.1.6.1**邮件配置**

###### 1.1.1.6.1.1**功能描述**

支持邮箱服务器信息的配置，配置变更后发送邮箱配置变更事件,邮件服务完成配置拨测和具体的邮件发送动作。

###### 1.1.1.6.1.2**功能设计**

1.1.1.6.1.2.1**查询邮件****配置信息**

返回邮件服务器配置信息,包含用户名,密码,邮件服务器地址,服务器端口号,邮件服务器拨测状态

1.1.1.6.1.2.2**修改邮件配置****信息**

修改邮件服务器配置信息,包含用户名,密码,邮件服务器地址,服务器端口号,当保存邮件配置信息后发送邮件配置变更事件,~~邮件服务接收~~~~到~~~~事件~~~~后开始拨测,~~~~拨测~~~~完成后调用系统服务邮件~~~~修改~~~~接口~~~~更新~~~~拨测状态~~

1.1.1.6.1.2.3**邮件配置拨测**

当提交邮件配置拨测请求后发送邮件配置拨测事件, 邮件服务接收到事件后开始拨测,拨测完成后调用系统服务邮件配置修改接口更新拨测状态

###### 1.1.1.6.1.3**数据结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps79.jpg) 

##### 1.1.1.6.2**短信配置**

###### 1.1.1.6.2.1**功能描述**

支持三大运营商短信网关的参数配置，配置变更后发送短信配置变更事件,短信服务完成配置拨测和具体的短信发送动作。

###### 1.1.1.6.2.2**功能设计**

1.1.1.6.2.2.1**查询短信配置**

返回短信网关配置信息,包含用户名,密码,短信网关地址,服务器端口号,SP接入号, 短信网关类型, 发送方号码,短信网关拨测状态。

1.1.1.6.2.2.2**修改短信配置**

修改短信网关配置信息,包含用户名,密码,短信网关地址,服务器端口号,SP接入号, 短信网关类型, 发送方号码,短信网关拨测状态, 短信服务接收到事件后开始拨测,拨测完成后调用系统服务短信配置修改接口更新拨测状态

1.1.1.6.2.2.3**短信****配置拨测**

当提交短信配置拨测请求后发送短信配置拨测事件,短信服务接收到事件后开始拨测,拨测完成后调用系统服务短信配置修改接口更新拨测状态

###### 1.1.1.6.2.3**数据结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps80.jpg) 

##### 1.1.1.6.3**HTTPS配置**

###### 1.1.1.6.3.1**功能描述**

提供上传证书功能，用户可以上传自己的安全证书，下发证书更新事件。

###### 1.1.1.6.3.2**功能设计**

1.1.1.6.3.2.1**上传证书**

提供上传证书功能，用户可上传自己的安全证书,上传文件分 cert文件和key,证书格式PEM

文件上传后保存到/data/platform/common/traefik/cert目录,

certFile文件名server.crt

keyfile文件名 server_key.pem

同时下发证书更新事件,系统配置服务接收到事件后重启traefik.完成证书刷新.

##### 1.1.1.6.4**日志外发配置**

###### 1.1.1.6.4.1**功能描述**

支持syslog、ftp方式进行日志外发。支持控制外发的系统日志类型(系统操作日志, 系统登录日志),日志服务根据已启用的日志外发配置,以JSON字符串格式外发到对应的端点

###### 1.1.1.6.4.2**功能设计**

1.1.1.6.4.2.1**分页查询日志外发配置列表**

分页查询日志外发配置列表，展示字段包括配置名称、发送方式、目标服务器IP、目标服务器端口、传输协议、日志类型、日志格式、状态。

1.1.1.6.4.2.2**新增日志外发配置**

1、 syslog日志外发：需要配置日志外发传输协议、syslog服务器IP地址、端口号、以及选择日志类型,。

2、 ftp日志外发：需要配置ftp服务器IP地址、端口号、ftp服务器路径、ftp服务器用户、ftp服务器用户密码、以及选择日志类型。

3、 保存后触发外发配置事件,日志服务接收到事件后根据参数信息判断为启用状态以JSON格式开始外发日志到对应端口

1.1.1.6.4.2.3**删除日志外发**

1、 将日志外发配置删除。

2、 保存后触发外发配置事件,日志服务接收到事件后根据参数信息判断为启用状态以JSON格式开始外发日志到对应端口

1.1.1.6.4.2.4**启用禁用日志外发配置**

启用的日志外发配置才能够生效，禁用的日志外发配置是不会生效的。

1、 保存后触发外发配置事件,日志服务接收到事件后根据参数信息判断为启用状态以JSON格式开始外发日志到对应端口

##### 1.1.1.6.5**电源管理**

###### 1.1.1.6.5.1**功能描述**

电源管理包含功能重启服务器和关闭服务器,该功能默认只有超级管理员才拥有该权限

###### 1.1.1.6.5.2**功能设计**

1、重启服务器

1、 重启服务器：产生重启服务器事件，系统配置服务接收重启服务器事件后调用系统接口完成服务器重启。

2、 关闭服务器：产生关闭服务器事件，系统配置服务接收重启服务器事件后调用系统接口完成服务器关闭。

##### 1.1.1.6.6**网络配置**

###### 1.1.1.6.6.1**功能描述**

配置服务器的IPV4以及IPV6地址、子网掩码、网关。

###### 1.1.1.6.6.2**功能设计**

1.1.1.6.6.2.1**网卡信息****上报接口**

系统配置服务通过该接口上报所属主机的网络配置(过滤掉虚拟网卡)信息网络配置包括IP,NETMASK,GATEWAY,DNS以及接口速率

和架构设计冲突点,主机上部署的系统配置服务都通过接口上报网卡状态,列表展示所有主机的网卡信息,修改配置下发事件后,系统配置服务接收到事件通过 主机名来判断是否本主机的网络配置请求

1.通过系统管理可用管理所有主机网络配置入口单一

2.不再需要登录到后台管理菜单来修改IP

1.1.1.6.6.2.2**查询所有网卡信息**

网卡信息包含主机名,网卡名称、各网卡对应的IPV4地址、IPV6地址、子网掩码、网关、网卡状态、接口速率。 

1.1.1.6.6.2.3**配置网卡****I****PV4**

配置网卡的IPV4地址、子网掩码、网关等信息。

产生配置网络事件，系统管理服务获取到对应的事件后调用系统接口完成配置,同时重启相关组件。

1.1.1.6.6.2.4**配置网卡****I****PV6**

配置网卡的IPV6地址、子网掩码、网关等信息。

产生配置网络事件，系统管理服务获取到对应的事件后调用系统接口完成配置,同时重启相关组件。

1.1.1.6.6.2.5**网络配置事件**

1. 系统配置服务更新系统hosts文件中IP和主机名的映射关系。

2. 系统配置服务调用系统接口完成网络配置。

3. 系统配置服务重启该主机上的组件。

4. 写缓存

##### 1.1.1.6.7**时间管理**

###### 1.1.1.6.7.1**功能描述**

获取系统时间、修改系统时间、配置ntp同步时间。

###### 1.1.1.6.7.2**功能设计**

1、 能够获取当前系统所支持的时区列表。

2、 可以获取当前系统所在时区，当前系统时间

3、 可以修改当前系统使用的时区、时间信息，修改系统时间会产生系统时间修改事件。

4、 配置ntp服务器地址 默认包含 阿里云的时间服务器和腾讯的时间服务器 也可以自定义NTP地址(域名或IP)。

1.1.1.6.7.2.1**时间配置上报接口**

系统配置服务通过该接口上报所属主机的时间配置信息,包括支持的时区列表,和当前系统配置的时区,NTP启用/禁用状态,NTP服务器地址

1.1.1.6.7.2.2**时间****查询接口**

返回系统管理服务所在服务器支持的时区列表和当前服务器所配置的时区信息以及当前时间

格式如下

{

 timezones:[“Asia/shanghai”,” Asia/hongkong”]

 timezone: Asia/shanghai

 time:”2021/02/02 20:20:20”

}

1.1.1.6.7.2.3**时间更新****接口**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps81.jpg) 

更新当前服务器时间,参数包含时间和时区

1.1.1.6.7.2.4**NTP配置****接口**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps82.jpg) 

1. 参数包含启用状态,NTP服务器地址,保存后发送事件NTP配置事件,系统配置服务接收到该事件后开启和禁用NTP时间同步

2. 当配置的是自定义服务器地址时,需保存当前自定义服务器地址到NTP服务器列表中

1.1.1.6.7.2.5**N****TP****地址列表****查询接口**

返回系统可配置的ntp服务器地址,启用禁用状态,当前选择的NTP服务器地址NTP时间同步接口

##### 1.1.1.1.1**配置备份**

###### 1.1.1.6.7.3**功能描述**

备份以及恢复当前服务器数据库数据。

###### 1.1.1.6.7.4**功能设计**

1.1.1.6.7.4.1**配置备份文件****列表**

1、 配置备份列表展示文件备份日期，备份文件大小，版本号以及操作列（操作列包含下载备份文件按钮和恢复备份文件按钮）。

2、 配置备份列表按照备份时间倒序排序。

3、 列表查询条件有备份日期范围查询。

1.1.1.6.7.4.2**导入备份文件**

1、导入备份文件必须下载后没有修改过的zip后缀类型加密压缩文件。

2、将导入文件放在指定/data/database/backup/目录下。

3、导入配置文件后先做文件校验,判断是否合法备份文件

4、导入备份文件需读取读备份文件的版本信息后入库 

5、产生备份恢复事件，其余工作在备份恢复事件中处理。

1.1.1.6.7.4.3**手动配置备份**

产生配置备份事件，其余工作在配置备份事件中处理。

1.1.1.6.7.4.4**删除备份**

删除服务器上的备份文件，删除配置备份表中的此备份文件记录信息。

1.1.1.6.7.4.5**下载备份**

下载指定的配置备份文件。

1.1.1.6.7.4.6**恢复备份**

1、 跨大版本之间的数据不能恢复，小版本默认是数据库结构没有变化允许恢复数据，如果跨大版本即使是数据库结构没有变化也不允许恢复。

2、 产生备份恢复事件。

1.1.1.6.7.4.7**F****TP外发配置**

保存ftp外发配置。配置信息包含IP地址、端口、用户名、密码、存放路径（真实存放路径为用户路径+填写的存放路径）。

1.1.1.6.7.4.8**配置备份****上报****接口**

配置备份服务通过该接口上报,配置备份信息包含 配置备份时间,配置备份文件大小,配置备份路径。

###### 1.1.1.6.7.5**数据结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps83.jpg) 

#### 1.1.1.7 **系统信息**

##### 1.1.1.7.1**系统****组件管理**

###### 1.1.1.7.1.1**功能描述**

组件状态监控主要对平台组件进行监控，目前监控的组件有用户服务、资源服务、系统服务、邮件服务、短信服务、日志服务、数据同步服务、主备服务、系统配置服务、升级服务、API网关、通知服务、定时任务服务、账号采集服务、核查服务

###### 1.1.1.7.1.2**功能设计**

1.1.1.7.1.2.1**系统****组件****状态上报****接口**

系统配置服务调用supervisor接口获取主机上运行的系统组件状态包含 服务名、PID、组件名同时调用系统接口获取主机的内存,CPU磁盘使用率一起上报给系统管理服务入库.

1.1.1.7.1.2.2**获取系统****组件****列表**

界面列表展示组件名称、IP，当前运行状态（启动中，正在运行、正在停止、已停止）、最后一次启动时间,系统CPU,内存,磁盘使用率。当组件状态为运行中可以对组件进行停止操作，当组件运行状态为已停止可对组件进行启动操作，同时提供下载运行日志链接下载运行日志。

1.1.1.7.1.2.3**停止系统****组件**

1.判断组件状态是否为运行中,如果状态为运行中修改系统组件状态为正在停止

2.下发停止组件事件,参数包含系统组件所在主机名,服务名,和PID,系统配置服务接收到事件后,通过主机名判断是否是本机进程,如果是本机进程通过supervisor接口停止对应的组件后调用系统组件状态上报接口更新组件状态为已停止.

1.1.1.7.1.2.4**启动****系统组件**

1.判断组件状态是否为停止状态,如果状态为停止修改系统组件状态为正在启动.

2.下发启动组件事件,参数包含系统组件所在主机名,服务名,和PID,系统配置服务接收到事件后,通过主机名判断是否是本机进程,如果是本机进程通过supervisor接口启动对应的组件后调用系统组件状态上报接口更新组件状态为运行中

1.1.1.7.1.2.5**日志****下载接口**

下载日志服务收集到的系统运行日志接口,~~日志~~~~服务默认保留~~~~7天~~~~日志~~,不限制日志保存天数依赖定时组件日志清理机制来完成磁盘空间释放,下载文件是需要指定下载那天的文件如果不指定接口默认返回当前的日志,下载文件格式为gzip格式(带密码校验,必须输入密码后才可以节约,日志存储时,过滤敏感字段不做保存)

##### 1.1.1.7.2**系统升级**

###### 1.1.1.7.2.1**功能描述**

上传系统升级包，发送系统升级事件，系统升级服务接受到事件后下载对应的升级包后执行升级脚本完成升级。

###### 1.1.1.7.2.2**功能设计**

1.1.1.7.2.2.1**升级文件目录结构**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps84.jpg) 

version.json内容

{

 "version":"3.1.1" //系统版本号

 "platform-user-service":"1.0.1", //组件版本号

 "platform-sms-service":"1.0.1" //组件版本号

}

1.1.1.7.2.2.2**上传****升级文件接口**

1、 系统升级前端上传升级包，调用系统升级后端服务，由后端服务完成升级包上传和存储文件存储在/data/files/upload目录。

2、 校验升级文件是否为合法文件，检验升级文件版本是否大于服务版本表内各服务版本信息，如果存在系统版本表内服务版本号小于升级包的版本才可以上传成功

3、 如果文件合法触发系统升级事件,内部包含升级文件名和下载路径，后台升级服务订阅升级通知。

4、 后台升级服务 调用系统服务的HTTP下载接口API下载升级包后解压升级包执行升级脚本开始升。

5、 后台升级服务调用系统升级后端上报升级结果、版本号、升级详情。

6、 系统升级前端通过API轮询升级进度和升级结果。

1.1.1.7.2.2.3**升级****历史记录列表**

返回历史升级记录列表包含更新版本号，更新时间，系统升级详情

1.1.1.7.2.2.4**下载****升级文件接口**

系统升级服务调用该接口下载升级包

1.1.1.7.2.2.5**升级状态查询接口**

查询升级服务上报的升级状态信息

1.1.1.7.2.2.6**升级完成上报****接口**

系统升级服务通过该接口上报当前系统上各个组件版本号，包含主机名和组件名，组件版本号,存入系统组件版本表中

##### 1.1.1.7.3**License管理**

###### 1.1.1.7.3.1**功能描述**

License控制系统功能权限，系统会初始化部分功能权限为license管控的功能权限，其中只有授予了license功能权限的功能点才可以使用。

###### 1.1.1.7.3.2**功能设计**

1.1.1.7.3.2.1**内置默认授权**

1、 平台部署完成后自带默认授权。

2、 内置的默认授权类型为试用授权，有效期为30天，带有一定（用户和资源）数量和全部功能。

3、 系统管理服务在第一次安装部署的时候，在主机下新建目录/data/platform/license/default，然后目录下新建default.license默认license授权文件。

4、 第二次重启系统管理服务的时候，会先判断/data/platform/license/default 目录下是否存在default.license文件，或者判断文件是否合法，存在不进行其余操作，如果不存在，那么在/data/platform/license/default目录下新建default.license默认授权文件

5、 默认授权内容如下：
```json
{

"deviceId": "564dfc97-a558-0253-fd1d-f5299aa0b116", #产品ID

"name": "~~admin~~试用授权",   #客户名称

"version":"3.0.2.3.1922" ,   #系统版本号

"masterLimit": 10,

"sysResLimit": 5,

"appResLimit":1,

"type": "default",

"auth": " sensitiveFound # desensitive# conflictSlave ",  #授权功能点 #分隔

"endTime": #导入日期后30天

}
```

6、 最后将json字符串加密存入default.license默认授权文件中。

1.1.1.7.3.2.2**展示授权**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps85.jpg) 

1、 展示license的基本信息，如客户名称、版本号、产品ID、授权类型、授权到期时间、授权用户数量（总共多少个、已使用多少个、剩余多少个）、授权系统资源数量（总共多少个、已使用多少个、剩余多少个）、授权应用功能资源数量（总共多少个、已使用多少个、剩余多少个），管控功能列表。

2、 正式授权不展示授权到期时间。

1.1.1.7.3.2.3**生成正式授权文件**

1、 授权工具生成正式授权。

2、 生成正式授权文件名称为【基础平台产品正式授权_客户名称_用户数XX_系统资源数XX_应用资源数XX.license】。

3、 正式授权内容为

```json
{

"deviceId": "564dfc97-a558-0253-fd1d-f5299aa0b116", #产品ID

"name": "admin",   #客户名称

"version":"3.0.2.3.1922" ,   #系统版本号

"masterLimit": 100,

"sysResLimit": 50,

"appResLimit":10,

"type": "official",

"auth": " sensitiveFound # desensitive# conflictSlave ",  #授权功能点 #分隔

}
```

4、 正式授权没有结束时间。

5、 最后将json字符串加密存入授权文件中。

1.1.1.7.3.2.4**生成试用授权文件**

1、 授权工具生成试用授权。

2、 生成正式授权文件名称为【基础平台产品试用授权_客户名称_用户数XX_系统资源数XX_应用资源数XX_授权到期时间-2021-03-09.license】。

3、 试用授权内容为

```json
{

"name": "admin",   #客户名称

"version":"3.0.2.3.1922" ,   #系统版本号

"masterLimit": 10,

"sysResLimit": 5,

"appResLimit":1,

"type": " temporary",

"auth": " sensitiveFound # desensitive# conflictSlave ",  #授权功能点 #分隔

"endTime": #导入日期后30天

}
```

4、 试用授权没有产品ID。

5、 最后将json字符串加密存入授权文件中。

1.1.1.7.3.2.5**导入license授权**

1、 正式授权导入：需要校验产品ID，产品ID不匹配提示授权文件不合法，存储于/data/platform/license/normal/normal.license文件中，如果normal.license文件中已存在内容，直接覆盖。

2、 试用授权导入：需要校验产品ID，产品ID不匹配提示授权文件不合法，存储于/data/platform/license/normal/normal.license文件中,如果normal.license文件中已存在内容，直接覆盖。

1.1.1.7.3.2.6**license授权控制**

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps86.jpg) 

1、 在上面的流程中，如果默认授权加载失败（文件丢失或者内容不合法），系统正常启动，在登录系统时给出提示。如果登录帐号有License管理功能权限则跳转到License管理界面，如果登录帐号没有License管理功能则提示联系管理员。

2、 对于试用授权（包括默认授权）到期前5天进行页面提醒重新授权。过期后如果登录帐号有License管理功能权限则跳转到License管理界面，如果登录帐号没有License管理功能则提示“系统授权已到期，请联系管理员”。

1.1.1.7.3.2.7**license信息与license控制功能点入库**

1、 在系统生成默认授权文件以及导入license授权文件后，会将license信息写入到数据库中。

2、 将license基本信息存入license授权信息表，这个表里面存储的为当前系统使用的license授权信息。

3、 将liecnse控制的功能点写入license授权控制表中，这个表中的所有数据为需要控制的授权功能点，当license控制功能点改变的时候，更新license授权控制表中的数据即可。

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps87.jpg) 

#### 1.1.1.8 **系统登录**

##### 1.1.1.8.1**统一登录界面**

###### 1.1.1.8.1.1**功能描述**

忘记密码：用户忘记密码后可通过短信或邮箱进行身份校验后改密，

相关下载：提供证书、用户手册、环境检测助手、运维客户端等下载功能，

国际化：支持中文和英文之间的切换。

###### 1.1.1.8.1.2**功能设计**

1.1.1.8.1.2.1**忘记密码**

忘记密码时通过手机验证码或者邮箱验证码，重置密码，平台提供忘记密码页面，登录服务器提供相关下载页面的跳转链接按钮。

1.1.1.8.1.2.2**相关下载**

平台提供相关下载页面，下载内容包含 管理基础控件，监控回放组件 证书, C/S 客户端,用户手册

所有文件都保存在/data/files/download目录

1.1.1.8.1.2.3**国际化**

页面提供国际化支持，可通过按钮实现语言切换。

##### 1.1.1.8.2**自服务**

###### 1.1.1.8.2.1**功能描述**

展示登录用户的详细信息并提供个人信息修改和密码修改功能。

###### 1.1.1.8.2.2**功能设计**

1.1.1.8.2.2.1**个人信息管理**

展示登录用户的详细信息并提供个人信息修改和密码修改功能

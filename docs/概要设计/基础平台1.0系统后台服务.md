---
created: 2023-09-20
number headings: first-level 2, start-at 1, max 6, 1.1-
title: 基础平台1.0系统后台服务
author: 罗潇
cssclass: wideTable
first-level: 1
pdf-filename: 基础平台1.0系统后台服务
platform: true
category: 概要设计
---

### 1.1.1 **系统****后台服务**

#### 1.1.1.1 **通知****服务**

##### 1.1.1.1.1**功能****描述**

通知服务监听kafka需发送短信或邮件相关事件,调用系统管理API获取配置的模板完成通知内容组装后发送对应的邮件或短信发送事件(邮件/短信通过不同topic来区分是发送短信还是发送邮件)

##### 1.1.1.1.2**功能****设计**

###### 1.1.1.1.2.1**事件****处理**

1. 短信登录事件

监控kafka消息队列里短信登录事件,解析消息参数后发送邮件,调用系统服务配置平台参数查询接口完成短信内容组装后(包含消息接受人电话号码,消息内容),发送短信发送事件,短信服务接收到短信发送事件后完成短信发送任务

2. 邮件登录事件

监控kafka消息队列里邮件登录事件,解析消息参数后发送邮件,调用系统服务配置平台参数查询接口完成邮件内容组装后(包含消息接受人邮箱地址,消息内容),发送邮件发送事件,邮件服务接收到邮件发送事件后完成邮件发送任务

3. 主备切换事件

监控kafka消息队列里主备切换事件,调用系统服务配置平台参数查询接口获取主备告警配置, 若配置了邮件告警完成邮件内容组装后(包含消息接受人邮箱地址,消息内容),发送邮件发送事件,邮件服务接收到邮件发送事件后完成邮件发送任务

若配置了短信告警完成短信内容组装后(包含消息接受人电话号码,消息内容),发送短信发送事件,短信服务接收到短信发送事件后完成短信发送任务

4. 改密事件

监控kafka消息队列里改密事件,调用系统服务配置平台参数查询接口获取改密配置, 若配置了邮件告警完成邮件内容组装后(包含消息接受人邮箱地址,消息内容),发送邮件发送事件,邮件服务接收到邮件发送事件后完成邮件发送任务

若配置了短信告警完成短信内容组装后(包含消息接受人电话号码,消息内容),发送短信发送事件,短信服务接收到短信发送事件后完成短信发送任务

5. 账号解锁事件

监控kafka消息队列里账号解锁事件,调用系统服务配置平台参数查询接口获取账号解锁配置, 若配置了邮件告警完成邮件内容组装后(包含消息接受人邮箱地址,消息内容),发送邮件发送事件,邮件服务接收到邮件发送事件后完成邮件发送任务

若配置了短信告警完成短信内容组装后(包含消息接受人电话号码,消息内容),发送短信发送事件,短信服务接收到短信发送事件后完成短信发送任务

6. 能力组件告警事件

监控kafka消息队列里能力组件告警事件,调用系统服务配置平台参数查询接口获取能力组件告警配置, 若配置了邮件告警完成邮件内容组装后(包含消息接受人邮箱地址,消息内容),发送邮件发送事件,邮件服务接收到邮件发送事件后完成邮件发送任务

若配置了短信告警完成短信内容组装后(包含消息接受人电话号码,消息内容),发送短信发送事件,短信服务接收到短信发送事件后完成短信发送任务

7. 服务器告警事件

监控kafka消息队列里服务器告警事件,调用系统服务配置平台参数查询接口获取服务器告警配置, 若配置了邮件告警完成邮件内容组装后(包含消息接受人邮箱地址,消息内容),发送邮件发送事件,邮件服务接收到邮件发送事件后完成邮件发送任务

若配置了短信告警完成短信内容组装后(包含消息接受人电话号码,消息内容),发送短信发送事件,短信服务接收到短信发送事件后完成短信发送任务

#### 1.1.1.2 **邮件****服务**

##### 1.1.1.2.1**功能****描述**

监听kafka的邮件发送事件完成邮件发送和服务拨测动作

##### 1.1.1.2.2**功能****设计**

###### 1.1.1.2.2.1**事件****处理**

1. 邮件发送事件

监控kafka消息队列里的邮件发送事件,当收到邮件发送解析消息参数后发送邮件,发送完成后发送邮件完成事件

2. 配置拨测事件

监控kafka消息队列里的 配置拨测事件,当收到配置拨测事件后解析事件参数尝试发送测试邮件后

重新发送拨测结果事件，系统服务监听事件，完成配置状态更新

#### 1.1.1.3 **短信****服务**

##### 1.1.1.3.1**功能****描述**

监听kafka的短信发送事件完成短信发送和短信配置拨测动作

##### 1.1.1.3.2**功能****设计**

###### 1.1.1.3.2.1**事件****处理**

1. 短信发送事件

监控kafka消息队列里的短信发送事件,当收到短信发送解析消息参数后发送邮件,发送完成后发送短信完成事件

2. 配置拨测事件

监控kafka消息队列里的 配置拨测事件,当收到配置拨测事件后解析事件参数尝试发送测试短信后, 重新发送拨测结果事件，系统服务监听事件,完成配置状态更新

#### 1.1.1.4 **API网关**

##### 1.1.1.4.1**权限处理**

权限管理时序图：

 ![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps88.jpg)

流程图：

 ![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps89.png)

网关鉴权说明：

当网关收到请求时，根据URL判断请求是否需要鉴权，不需要鉴权的直接执行反向代理；对于需要鉴权的请求，将请求转发给鉴权服务器校验权限，权限校验通过时鉴权服务器将返回HTTP 200响应（响应头中携带有包含用户信息的）给网关，网关收到[200,300)之间的HTTP 响应码时将请求反向代理到后端服务器；校验失败返回非HTTP [200,300)之间的状态码给网关，网关不会执行后续步骤，直接将鉴权服务器的响应原样返回给客户端。

鉴权服务器说明：

鉴权服务器收到鉴权请求，首先判断是否登录。未登录的，返回HTTP重定向到cas登录服务器给网关，网关将重定向返回给客户端，引导客户端去登录，登录成功后cas登录服务器携带票据ticket重定向到网关，网关将请求转发给鉴权服务器，鉴权服务器判断票据是否有效，无效则再次返回登录重定向引导客户端去登录；票据合法则返回重定向设置cookie来标识当前请求已登录，重定向地址为当前请求地址，随后网关再次收到请求并将请求转发给鉴权服务器，鉴权服务器判断已登录，就校验已登录用户是否有权限访问当前URL，校验通过返回HTTP 200 并在响应头中携带用户信息JWT给网关，网关收到[200,300)之间的HTTP 响应码时将请求反向代理到后端服务器；校验失败返回非HTTP 403状态码给网关，网关不会执行后续步骤，直接将鉴权服务器的403响应原样返回给客户端。

##### 1.1.1.4.2**路由配置**

网关采用 traefik，路由、路由入口点、service 提供者配置使用静态配置，通过文件配置好，其中service配置为从http 接口中获取，这个http接口由系统管理及组件监控提供。service 对应的应用地址，由各个模块在自己的配置文件中配置好并在启动的时候自动将信息注册到 zookeeper 中，系统管理和组件监控服务在启动时除了将自身注册到zookeeper中，还会配置一个提供traefik service信息的api，这个api在收到请求时会从zookeeper中近乎实时的（本地缓存1-2秒）读取服务注册的信息然后组装成traefik 网关需要的service信息，traefik将会5s定时从这个api中取出service的配置，从而做到服务发现实现动态路由；当服务离线后，zookeeper中的service信息将会被自动删除，traefik从http 接口中获取到的service信息将会减少，从而感知到服务离线；当系统管理或者组件监控其中一个服务离线，对traefik 无影响，当两个都离线时，traefik无法获取新的service信息，traefik已有的老的service信息不会改变，直到系统管理和组件监控服务其中之一或全部重新上线。如下图所示：

![](file:////private/var/folders/rl/gchkw9l93p149mmyj8t07w280000gn/T/com.kingsoft.wpsoffice.mac.global/wps-xiaoluo/ksohtml//wps90.png)

#### 1.1.1.5 **日志****服务**

##### 1.1.1.5.1**功能****描述**

系统日志服务为后台服务，提供所有子系统和服务的日志记录功能。所有子系统和服务把日志通过消息中心给系统日志服务，由系统日志服务完成日志持久化及日志外发动作。系统登录日志和系统操作日志清理在定时任务组件中处理。

##### 1.1.1.5.2**功能****设计**

###### 1.1.1.5.2.1**日志外发**

外发日志格式为json，当从kafka订阅收到日志的时候，根据日志外发配置决定是否外发、通过何种协议外发，确定外发及外发协议后将日志提交到外发日志队列中，交由日志外发线程池异步发送，不影响后续从kafka收日志。发送的json包含 content（日志内容，从kafka收到的日志内容）、type（日志类型，系统登录日志、系统操作日志、系统运行日志、能力组件日志）、module（日志所属模块，用户管理、系统管理、资源管理）字段。

###### 1.1.1.5.2.2**系统登录日志**

订阅kafka系统登录日志相关 topic，收到日志后记录到数据库系统登录日志表中。

###### 1.1.1.5.2.3**系统操作日志**

订阅kafka系统操作日志相关 topic，收到日志后记录到数据库系统操作日志表中。

###### 1.1.1.5.2.4**系统运行日志**

订阅kafka系统运行日志相关 topic，收到日志后通过log4j记录到文件中，日志保留最近七天。

#### 1.1.1.6 **定时****任务服务**

##### 1.1.1.6.1**功能****描述**

完成用户核查等固定频率任务

##### 1.1.1.6.2**功能****设计**

1. 用户核查任务

调用用户管理API对用户进行僵尸，孤儿相关核查任务

2. 能力组件状态采集

能力组件包括2018堡垒机，ASCG

1.调用系统管理服务能力组件API获取能力组件的配置信息，然后调用能力组件状态采集接口完成状态数据采集,最后调用系统管理服务接口上报能力组件状态数据

2. 调用系统管理能力服务组件API获取能力组件的配置信息，然后调用版本查询接口完成查询能力组件版本信息,最后调用系统管理服务接口上报能力组件版本信息

3. 调用系统服务参数配置接口获取服务磁盘阈值配置信息，检测系统是否需要清理系统操作日志、系统登录日志，当磁盘使用达到90%的时候，一次删除一天的系统登录日志和系统操作日志，直到磁盘使用低于90%

#### 1.1.1.7 **数据****同步服务**

##### 1.1.1.7.1**功能****描述**

日志服务监听kafka用户服务,资源服务数据变更事件后补齐数据调用系统服务API查询对应的能力组件配置,调用各能力组件接口完成用户数据,资源数据同步

##### 1.1.1.7.2**功能****设计**

1.堡垒机数据同步

2.ASCG数据同步

###### 1.1.1.7.2.1**能力组件新增事件数据同步**

1、 调用堡垒机或ASCG接口通知它们已经在基础平台上进行了注册。

2、 调用用户管理服务组织机构查询查询接口获取所有组织机构信息，然后将组织信息封装，调用堡垒机、ASCG组织机构新增接口同步组织机构数据到能力组件。

3、 调用用户管理服务用户查询接口获取所有用户信息，然后将用户信息封装，调用堡垒机、ASCG用户新增接口同步用户数据到能力组件。

###### 1.1.1.7.2.2**组织机构增删改事件数据同步**

1、 新增组织机构事件：从事件中拿到新增的组织机构信息，封装数据，然后调用堡垒机、ASCG新增组织机构接口同步组织机构数据。

2、 修改组织机构事件：从事件中拿到修改的组织机构信息，封装数据，然后调用堡垒机、ASCG修改组织机构接口同步组织机构数据。

3、 删除组织机构事件：从事件中拿到删除的组织机构信息，封装数据，然后调用堡垒机、ASCG删除组织机构接口同步组织机构数据。

###### 1.1.1.7.2.3**用户增删改事件数据同步**

1、 新增用户事件：从事件中拿到新增的用户信息，封装数据，然后调用堡垒机、ASCG新增用户接口同步用户数据。

2、 修改用户事件：从事件中拿到修改的用户信息，封装数据，然后调用堡垒机、ASCG修改用户接口同步用户数据。

3、 删除用户事件：从事件中拿到删除的用户信息，封装数据，然后调用堡垒机、ASCG删除用户接口同步用户数据。

###### 1.1.1.7.2.4**资源组增删改事件数据同步**

1、 新增资源组事件：从事件中拿到新增的资源组信息，封装数据，然后调用堡垒机新增资源组接口同步资源组数据。

2、 修改资源组事件：从事件中拿到修改的资源组信息，封装数据，然后调用堡垒机修改资源组接口同步资源组数据。

3、 删除资源组事件：从事件中拿到删除的资源组信息，封装数据，然后调用堡垒机删除资源组接口同步资源组数据。

###### 1.1.1.7.2.5**系统资源增删改事件数据同步**

1、 新增系统资源事件：从事件中拿到新增的资源信息，封装数据，然后调用堡垒机新增资源接口同步资源数据；从事件中拿到资源绑定的协议信息，然后调用堡垒机服务新增接口。

2、 修改系统资源事件：从事件中拿到修改的资源信息，封装数据，然后调用堡垒机修改资源接口同步资源数据；从事件中拿到资源绑定的协议信息，与原来资源下绑定的协议信息进行比对，如果有新增的协议，那么调用堡垒机协议新增接口，如果是修改的协议，那么调用堡垒机协议修改接口，如果是删除的协议，那么调用堡垒机协议删除接口。

3、 删除系统资源事件：从事件中拿到删除的资源信息，封装数据，然后调用堡垒机删除资源接口同步资源数据。

###### 1.1.1.7.2.6**应用资源增删改事件数据同步**

1、 新增应用资源事件：从事件中拿到新增的资源信息，封装数据，然后调用ASCG新增资源接口同步资源数据。

2、 修改应用资源事件：从事件中拿到修改的资源信息，封装数据，然后调用ASCG修改资源接口同步资源数据。

3、 删除应用资源事件：从事件中拿到删除的资源信息，封装数据，然后调用ASCG删除资源接口同步资源数据。

###### 1.1.1.7.2.7**资源帐号增删改事件数据同步**

1、 新增帐号事件：从事件中拿到新增的帐号信息，封装数据，然后调用堡垒机、ASCG新增帐号接口同步帐号数据。

2、 修改帐号事件：从事件中拿到修改的帐号信息，封装数据，然后调用堡垒机、ASCG修改帐号接口同步帐号数据。

3、 删除帐号事件：从事件中拿到删除的帐号信息，封装数据，然后调用堡垒机、ASCG删除帐号接口同步帐号数据。

###### 1.1.1.7.2.8**资源组关联能力组件数据同步**

1、 调用资源管理服务获取关联的资源组信息，然后封装数据，调用堡垒机资源组新增接口同步资源组信息到堡垒机。（ASCG不需要同步资源组数据）

2、 调用资源管理服务获取资源组下的所有资源，然后封装数据，调用堡垒机或ASCG资源新增接口同步资源信息到堡垒机或ASCG。如果是系统资源，那么从获取到的资源信息中拿到协议信息，调用堡垒机协议新增接口同步协议信息到堡垒机。

3、 调用资源管理服务获取资源组下资源的所有帐号信息，然后封装数据，调用堡垒机或ASCG帐号新增接口同步帐号信息到堡垒机或ASCG。

###### 1.1.1.7.2.9**资源组取消关联能力组件数据同步**

1、 调用资源管理服务获取资源组下资源的所有帐号信息，然后封装数据，调用堡垒机或ASCG帐号删除接口同步帐号信息到堡垒机或ASCG。

2、 调用资源管理服务获取资源组下的所有资源，然后封装数据，调用堡垒机或ASCG资源删除接口同步资源信息到堡垒机或ASCG。

3、 调用资源管理服务获取取消关联的资源组信息，然后封装数据，调用堡垒机资源组删除接口同步资源组信息到堡垒机。

###### 1.1.1.7.2.10**能力组件删除事件数据同步**

1、 调用堡垒机或ASCG接口通知它们已经在基础平台上取消了注册。

2、 至于能力组件需不需要删除由基础平台同步的数据由能力组件自行决定。

#### 1.1.1.8 **系统****配置服务****(ROOT)**

##### 1.1.1.8.1**功能****描述**

该服务运行在宿主机上,提供网络,时间和主机上运行的组件状态,主机CPU 内存 磁盘使用率上报,以及监听kafka事件实现系统网络配置,时间配置,电源配置功能

##### 1.1.1.8.2**功能设计**

###### 1.1.1.8.2.1 **网络时间****配置**

1.服务启动时,通过系统调用获取当前主机的网络配置信息和时间配置信息,调用系统管理网络配置接口上报当前机器网络配置信息,网络配置包括IP,NETMASK,GATEWAY,DNS以及接口速率,时间配置信息包含当前系统所在时区和当前系统支持的时区,NTP启用/禁用状态,NTP服务器地址,系统服务通过读取数据库网络获取时间配置和网络的配置信息

2.系统服务在启动后每30s上报一次网络配置,时间配置,以及系统状态数据(CPU负载,磁盘信息,内存),以及系统运行组件状态信息

###### 1.1.1.8.2.2**事件****处理**

1.网络配置事件

系统配置服务监控kafka消息队列里的 网络配置事件,当收到网络配置事件

l 根据消息参数中的主机标识判断是否与本机匹配,如果匹配调用系统API修改主机的网络配置

l 发送网络配置完成事件

2.时间配置事件

系统配置服务监控kafka消息队列里的 时间配置事件,当收到事件配置事件

根据消息参数中的主机标识判断是否与本机匹配,如果匹配后调用系统API修改主机的时间配置

3.电源配置事件

系统配置服务监控kafka消息队列里的 电源配置事件,当收到事件配置事件

根据消息参数中的主机标识判断是否与本机匹配,如果匹配后调用系统API重启或关闭主机

4.网络变更完成事件

更新hosts文件中对应的 域名和ip的映射关系

5.服务启动事件

系统配置服务监控kafka消息队列里的 服务启停事件,当收到事件配置事件读取对应的事件参数调用supervisor API 完成服务启停后调用系统组件接口上报对应的组件状态信息

#### 1.1.1.9 **配置****备份服务****(ROOT)**

##### 1.1.1.9.1**功能****描述**

该服务运行在宿主机上,完成定时备份数据库,以及监听kafka的手工配置备份事件和恢复配置备份事件

##### 1.1.1.9.2**功能****设计**

###### 1.1.1.9.2.1**定时****备份**

1.服务启动是已固定频率2小时,读取配置文件中的表集合通过pg_dump命令来完成配置备份

2. 具体备份表：除了系统操作日志表、登录日志表、系统在线用户表 都需要备份

###### 1.1.1.9.2.2**事件处理**

1. 手动备份事件

监控kafka消息队列里的 手动备份事件,当收到事件配置事件读取配置文件中的表集合通过pg_dump命令来完成配置备份,文件备份路径/data/database/backup/ 

备份完成后发送配置完成事件后调用系统管理服务接口上报配置备份信息(备份时间,备份文件大小,备份文件路径)

2. 恢复备份事件

监控kafka消息队列里的 恢复备份事件,当收到恢复备份事件调用pg_dump命令完成恢复备份配置

恢复备份配置完成后发送恢复备份配置完成事件 

#### 1.1.1.10 **升级****服务****(ROOT)**

##### 1.1.1.10.1**功能****描述**

该服务运行在宿主机上,监听kafka的升级事件完成系统升级功能

##### 1.1.1.10.2**功能****设计**

监控kafka消息队列里的升级事件,解析事件参数,通过http接口下载相关升级包,解压执行升级包中的install.sh脚本完成升级。备份、覆盖文件和重启服务功能在脚本内实现,升级服务只解压升级包和调用install.sh脚本

#### 1.1.1.11 **主备****服务****(ROOT)**

该服务运行在宿主机上,查看主备章节描述

##### 1.1.1.11.1**功能****描述**

##### 1.1.1.11.2**功能****设计**

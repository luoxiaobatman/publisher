---
created: 2023-09-22
number headings: first-level 2, start-at 1, max 6, 1.1-
title: 运行架构图
author: 罗潇
cssclass: wideTable
first-level: 1
pdf-filename: 基础平台2.0运行架构图
platform: true
category: 架构设计
---

# **运行架构**

关注系统内部逻辑结构、处理流程，展示各组件的交互和通信方式及其协议等，面向系统设计、开发人员。

## **运行架构图**

系统运行如下：

![[../assets/img/Pasted image 20230925181828.png|Pasted image 20230925181828]]

* 基础平台整体基于iTR系统平台提供的运行环境，中间件等运行，服务层以微服务方式运行。

* 服务网关：spring cloud gateway实现，用于服务的注册与发现，监控检查，身份认证，接口鉴权，请求路由以及负载均衡等，是整个服务集群的服务暴露点。

* 微服务：包含基础平台自带用户服务，资产服务，系统服务，以及各产品的业务服务模块应用。

* 反向代理：nginx中间件，部署静态资源、动态请求转发、https等功能。

## **控制流组织**

### **身份认证**

![[../assets/img/Pasted image 20230925181852.png|Pasted image 20230925181852]]

1. 服务网关采用非阻塞式编程，响应式结果处理。Restful接口调用不会占用线程进行同步等待结果，这样提高线程池的线程的利用率。

2. 其他服务采用标准Spring MVC编程，阻塞式编程，响应请求期间都会独占一个线程。

3. 网关和服务都有独立请求线程池，线程池的线程上限都可以动态配置。网关的线程池由Netty控制，服务的线程池由Tomcat控制。

4. 网关、服务之间调用采用Restful接口，底层依赖Http协议。

5. 网关会采用限流进行自我保护，限流上线为100/s。网关考虑引入缓存，但这会导致业务流程更复杂，用户服务变用户信息后需通知网关清理缓存。

6. 用户服务查询用户信息添加缓存，避免大量认证冲垮Postgresql。用户信息变更清理缓存，但是在一个服务操作，操作相对简单并且稳定。

### **IP修改**

![[../assets/img/Pasted image 20230925181908.png|Pasted image 20230925181908]]

1. 系统服务调用系统平台接口时需要加锁，保证同一时间只能一个操作修改IP。

2. 网关服务在用户会话中缓存用户权限信息，避免频繁调用用户服务查询权限。

系统服务和系统平台交互采用同步串行方式，虽然会一直占用一个线程，但是同步编程更简单，更稳定，响应更及时。
---
created: 2023-09-22
number headings: first-level 2, start-at 1, max 6, 1.1.
title: 数据架构图
author: 罗潇
cssclass: wideTable
first-level: 1
pdf-filename: 基础平台2.0数据架构图
platform: true
category: 架构设计
---

# 持久化机制

业务数据持久化存储在业务库，业务库使用关系型数据库Postgresql。

为减轻数据库访问压力，对于高频访问数据采用缓存，本地缓存采用内存或Ehcache，Ehcache采用本地文件存储。如果采用分布式缓存库Redis，持久化也采用本地文件存储。redis持久化机制分为RDB和AOF，建议数据量小缓存采用RBD，数据量大的缓存采用RDB+AOF。

消息中间件采用嵌入式ActiveMQ和Kafka。

ActiveMQ采用Postgresql存储,如果出现性能问题，考虑使用KahaDB，采用本地文件存储**。**

Kafka采用本地文件存储。

配置协同中间件Zookeeper采用本地文件存储。

升级包，导入文件，临时文件，配置文件等采用本地文件存储。

![[../assets/img/Pasted image 20230926154557.png|Pasted image 20230926154557]]

# 持久化存储方案

## 业务库设计

基础平台默认提供资产服务，用户服务，系统服务，针对三个服务分别独立设计表结构。

资产服务表名以，t_res_作为前缀。

用户服务表名以，t_usr_作为前缀。

系统服务表名以，t_sys_作为前缀。

三个服务具体表结构设计在功能设计阶段细化。

## 缓存库设计

缓存对象设计原则：

1. 准入规则：纳入缓存的对象可能是全局状态对象，如登录信息；或高频读取热点数据，如规则类数据。

2. key值选取，业务逻辑侧驱动，以能够快速查找索引为宜。

3. 定义合适的过期策略，利于数据的被动刷新，同时提高redis内存使用效率，同时防止雪崩。

4. 缓存对象的设计，一定是满足快速使用为优先，在初始化、同步时的一些转换是可接受的。

5. 明确缓存对象的维护方和使用方，制定相应机制保证数据的一致性。

6. Key值取值规则：｛产品名简写｝:｛实体名简写｝,冒号分隔。

基于以上原则，在理顺系统核心业务和执行逻辑的情况下，统一定义、扩充至此处：

| **缓存对象** | **Key**            | **使用场景**                 | **过期策略** |
| ------------ | ------------------ | ---------------------------- | ------------ |
| 用户会话     | platform:user:info | 用户登录成功后缓存用户信息。 |              |
| 用户角色     | Platform:user:role | 用户角色信息                 |              |
| 用户权限     | Platform:user:role | 用户权限信息                 |              |

## MQ存储设计

MQ消息存储本地文件系统或Postgresql中，主要用以异步任务处理和消息广播。由于当前信息量不大，考虑json格式，可更换为性能更优的其他编码方式。

资产服务Topic名以，t_res_作为前缀。

用户服务Topic名以，t_usr_作为前缀。

系统服务Topic名以，t_sys_作为前缀。

## 其他存储设计

1. 上传文件

如excel导入功能上传的文件，服务模块存上传临时目录/data/XXXX/files/upload，使用完成后即删除。

2. 临时文件

服务模块存临时目录/data/XXXX/files/tmp，使用完成后即删除。

3. 配置文件

服务模块存上传临时目录/data/XXXX/files/config。

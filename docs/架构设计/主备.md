---
created: 2023-09-20
number headings: first-level 2, start-at 1, max 6, 1.1-
title: 主备
author: 罗潇
cssclass: wideTable
first-level: 1
pdf-filename: 主备
platform: true
category: 架构设计
---

### 主备

![[../assets/img/Pasted image 20230920135520.png|Pasted image 20230920135520]]

前端调用系统管理服务API发起主备配置操作，系统管理服务向消息中心发送主备配置命令，后台主备服务订阅消息执行主备动作：主备数据同步，数据同步后通过主备事件处理程序上报主备切换完成事件给消息中心，同时通过API上报给系统管理后端用于界面展示，通知服务订阅该事件，并通过短信服务或邮件服务给管理员发送通知。

* 服务状态监控

系统运行过程中，服务状态监控程序（HA）监控相关服务的状态，并根据监控的服务的状态综合判断是否需要执行主备切换。

服务状态监控来源于两个方面：

1） 从守护进程获取服务状态，获取拉取三次都不成功的服务的状态

2） 由服务状态监控程序执行业务拨测进行判断。针对数据库真正执行一条sql检查pg的可用性、连接是否占满；针对API网关真正执行一次http请求，检查网关是否有响应。

主备切换的判断依据是以下服务中任何一个启动三次失败或业务拨测失败则进行主备切换。

1） API网关

2） 认证中心

3） 用户管理

4） DB

5） 消息中心

除以上服务外，其他服务异常时不会进行准备切换，依赖系统组件监控模块进行监控并人工参与来恢复服务。

* 主备数据同步

主备配置完成或主备切换完成后，会利用切换后的主机的数据覆盖备机的数据，达到主备数据一致的效果。

正常运行过程中心，主机数据变更时会利用pglogical准实时地、主动推送数据到备机。

* 主备事件处理

把服务状态监控结果、主备数据同步结果及问题以事件的形式上报到消息中心、上报给系统管理，分别为短信邮件通知、日志记录、系统组件状态监控提供基础。

说明：主备只考虑单机部署的情况，不考虑分布式部署和云化部署。
